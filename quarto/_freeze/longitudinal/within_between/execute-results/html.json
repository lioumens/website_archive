{
  "hash": "7712ec96b2476673b2afeb198bd1e562",
  "result": {
    "markdown": "---\ntitle: \"The Within-Between Model\"\nauthor: \"Michael Liou\"\nformat: \n  html:\n    mainfont: Palitino\n    code-fold: true\n    theme: lumen\n    linestretch: 1.2\n    fontsize: 1em\n    html-math-method: katex\nexecute:\n  cache: true\n---\n\n::: {.cell hash='within_between_cache/html/unnamed-chunk-1_b36b11a2819e347ea59c1fb524ce72a4'}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Load Libraries\"}\nlibrary(tidyverse)\nlibrary(nlme)\nlibrary(lme4)\nlibrary(plm)\nlibrary(kableExtra)\n```\n:::\n\n\n## Introduction\n\nThis material is largely sourced from Chapter 9 of Longitudinal Data Analysis.\n\nFor fixed effects models,\n\n- $X_{ij}$ is independent of $\\varepsilon_{ij}$ and $\\varepsilon_{ij'}$.\n  - an observation will not help determine the value of the next\n- FE models \"clear out\" any higher level trends, and just focus on the within estimate\n- The $\\hat\\beta$ estimate will be consistent even when the higher level effect is correlated with the covariates.\n\n## The Model \n\nTo introduce the model, we will look at a simulated example where there is a higher level effect\n\n\n::: {.cell hash='within_between_cache/html/unnamed-chunk-2_7786f76fece01c94f6e4d73e7ec1c500'}\n\n```{.r .cell-code  code-fold=\"true\"}\n# simulated  \ndat_skel <- data.frame(cohort = rep(1:3, each = 16),\n           id = rep(1:12, each = 4),\n           age = c(rep(c(4, 6, 7, 10), 4), # cohort 1\n                   rep(c(4, 5, 8, 9) + 1, 4), # cohort 2 \n                   rep(c(4, 7, 8, 10) + 2, 4))) # cohort 3\n# creating data\nset.seed(1)\nid_int <- rnorm(12, 2) + 10\nid_slope <- rnorm(12, mean = 1, sd = .01) # random slope\ncohort_int <- c(1, 4, 7)\n\ndat <- dat_skel %>% \n  mutate(y = id_int + id_slope * age + cohort_int[cohort] + rnorm(nrow(.), sd = 5),\n         id = factor(id),\n         cohort = factor(cohort))\n\ndat %>% head()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n  cohort id age        y\n1      1  1   4 19.44783\n2      1  1   6 18.77012\n3      1  1   7 18.46414\n4      1  1  10 17.23703\n5      1  2   4 14.93811\n6      1  2   6 20.32587\n```\n:::\n:::\n\n::: {.cell hash='within_between_cache/html/unnamed-chunk-3_bc2ee2dd5ab3fbdbd9b3628808100fc1'}\n\n```{.r .cell-code  code-fold=\"true\"}\ndat %>% ggplot(aes(age, y, color = cohort, group = id)) +\n  geom_point() +\n  geom_line()\n```\n\n::: {.cell-output-display}\n![](within_between_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n::: {.cell hash='within_between_cache/html/unnamed-chunk-4_ad79ec24fbe29cd91418fd015c4a336e'}\n\n```{.r .cell-code}\ndat_centered <- dat %>% arrange(id, age) %>%\n  group_by(id) %>% \n  mutate(age_mean = mean(age),\n         y_mean = mean(y),\n         age_centered = age - age_mean,\n         y_centered = y - y_mean,\n         age_baseline = age - first(age),\n         y_baseline = y - first(y))\n\ndat_baseline <- dat_centered %>% \n  filter(age_baseline != 0)\n```\n:::\n\n::: {.cell hash='within_between_cache/html/unnamed-chunk-5_ab649f61a0a33846b701ac3e9cbcdd4c'}\n\n```{.r .cell-code}\n# Fixed Effect Estimate (within model)\ncentered_lm <- lm(y_centered ~ age_centered, data = dat_centered) # centered regression\n\n# between model\nbaseline_lm <- lm(y_baseline~age_baseline, data = dat_baseline) # baseline adjusted (centered)\nid_lm <- lm(y~age + id, data = dat_centered) # id model (centered)\n\nmean_lm <- lm(y_mean ~ age_mean, data = dat_centered) # mean regression (pooled model)\n\npooled_lm <- lm(y~age, data = dat_centered)\n\ncohort_lm <- lm(y~age + cohort, data = dat_centered)\n\n# mixed model\nmmod <- lmer(y ~ age + (1|id), data = dat)\n\n# within-between model\nwb_mmod <- lmer(y~age_centered + age_mean + (1 | id), data = dat_centered)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nboundary (singular) fit: see help('isSingular')\n```\n:::\n:::\n\n::: {.cell hash='within_between_cache/html/unnamed-chunk-6_c4a5e40e57574f76a51fe247d1ab632c'}\n\n```{.r .cell-code  code-fold=\"true\"}\ncbind(\n  baseline_lm = coef(baseline_lm),\n  mean = coef(mean_lm),\n  cohort = coef(cohort_lm)[1:2],\n  id = coef(id_lm)[1:2],\n  pooled = coef(pooled_lm),\n  centered = coef(centered_lm),\n  mixed = fixef(mmod)) %>% rbind(NA) %>% \n  cbind(within_between = fixef(wb_mmod))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n             baseline_lm      mean    cohort       id    pooled     centered\n(Intercept)    -0.508907 -3.670061 11.107892 9.596570 10.993983 4.411316e-16\nage_baseline    1.316630  3.640294  1.316031 1.316031  1.768289 1.316031e+00\n                      NA        NA        NA       NA        NA           NA\n                 mixed within_between\n(Intercept)  12.131986      -3.670061\nage_baseline  1.623012       1.316031\n                    NA       3.640294\n```\n:::\n:::\n\n\n$$\n\\begin{aligned}\nw = \\frac{(1 - \\rho_y)\\rho_x}{(1 - \\rho_y) + n\\rho_y(1-\\rho_x)}\n\\end{aligned}\n$$\nand \n\n$$\n\\begin{aligned}\n\\hat \\beta_2^{(RE)} = (1 - w)\\hat\\beta_2^{(FE)} + w\\hat\\beta_2^{(B)}\n\\end{aligned}\n$$\n\n\n::: {.cell hash='within_between_cache/html/unnamed-chunk-7_181f1847ff22ba9e0e5aab589cf6a49b'}\n\n```{.r .cell-code}\n# help function for weight\nfixed_random_weight <- function(rho_x, rho_y, n) {\n  (1-rho_y) * rho_x / ((1-rho_y) + n * rho_y * (1 - rho_x))\n}\n```\n:::\n\n::: {.cell hash='within_between_cache/html/unnamed-chunk-8_abea4c508c7e8dd5750f59c423fc0766'}\n\n```{.r .cell-code}\n# response correlation\nrho_y <- VarCorr(mmod) %>% as.data.frame() %>% pull(vcov) %>% \n  as_mapper(~.x[1]/sum(.x))()\n\n# correlation of age\nage_lm <- lm(age~id, data = dat_centered)\nrho_x <- summary(age_lm)$r.squared\n\nn <- 4\nw <- fixed_random_weight(rho_x, rho_y, n)\n(1-w) * fixef(wb_mmod)[2] + w * fixef(wb_mmod)[3]\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nage_centered \n    1.623012 \n```\n:::\n:::\n\n::: {.cell hash='within_between_cache/html/unnamed-chunk-9_59cddd6b4d8815d52e505aa8e52158cd'}\n\n```{.r .cell-code}\ndat %>% ggplot(aes(age, y, color = cohort, group = id)) +\n  geom_point(alpha = .2) +\n  geom_line(alpha = .2) +\n  geom_abline(slope = coef(centered_lm)[2], intercept = coef(centered_lm)[1] + 10) + # centered estimate\n  geom_abline(slope = coef(mean_lm)[2], intercept = coef(mean_lm)[1]) + # mean estimate\n  geom_abline(slope = fixef(mmod)[2], intercept = fixef(mmod)[1], linetype = 2) + # mixed effects estimate\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](within_between_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n## FEV example\n\n\n\n::: {.cell hash='within_between_cache/html/unnamed-chunk-10_b2a5d786d10c805acef591e06d42b75a'}\n\n```{.r .cell-code}\nlibrary(foreign)\nfev <- read.dta(\"data/fev1.dta\") %>% \n  filter(id != 197) %>%\n  mutate(id = factor(id),\n         y =  logfev1 - 2 * (log(ht)))\n\nfev_centered <- fev %>% group_by(id) %>% \n  mutate(\n    y_mean = mean(y),\n    age_mean = mean(age),\n    age_centered = age - age_mean)\n```\n:::\n\n::: {.cell hash='within_between_cache/html/unnamed-chunk-11_94e128e74e7316ec0b2b9602d430a5b0'}\n\n```{.r .cell-code}\n# fitting all models\nfev_lm <- lm(y ~ age + id, data = fev) # lm\nfev_mer <- lmer(y~age + (1|id), data = fev) # random\n\n# within/between model\nfev_wb <- lmer(y ~ age_centered + age_mean + (1|id),\n               data = fev_centered,\n               REML = FALSE)\n\n# cross sectional\nfev_mean_lm <- lm(y_mean ~ age_mean, data = fev_centered)\n\n\n# age correlation (between/within)\nfev_age_lm <- lm(age ~ id, data = fev)\n```\n:::\n\n::: {.cell hash='within_between_cache/html/unnamed-chunk-12_acbb498352958d06dbe2c59ad2acdc04'}\n\n```{.r .cell-code}\n# comparing the coefficients\ncbind(fixed = coef(fev_lm)[1:2],\n      random = fixef(fev_mer),\n      mean = coef(fev_mean_lm)) %>% \n  rbind(NA) %>% cbind(within_between = fixef(fev_wb))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                  fixed      random        mean within_between\n(Intercept) -0.39873981 -0.35517115 -0.37154929    -0.34833979\nage          0.02982264  0.02980696  0.03109488     0.02982264\n                     NA          NA          NA     0.02923539\n```\n:::\n:::\n\n::: {.cell hash='within_between_cache/html/unnamed-chunk-13_03b5ca00287f0e7e6e3cf6ff6820ce46'}\n\n```{.r .cell-code}\nrho_y <- VarCorr(fev_mer) %>% \n  as.data.frame() %>%\n  pull(vcov) %>%\n  as_mapper(~.x[1]/sum(.x))() # .689\n\n# age covariance\n# fev_age_ss <- anova(fev_age_lm)$`Sum Sq`\n# rho_x <- fev_age_ss[1] / sum(fev_age_ss) \nrho_x <- summary(fev_age_lm)$r.squared # .172\n\nnbar <- fev %>% count(id) %>% pull(n) %>% mean()\n\nw <- fixed_random_weight(rho_x, rho_y, nbar)\nw\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0.01297669\n```\n:::\n:::\n\n\nSince this value of w is very low we expect that the mixed estimate is very close to the fixed estimate.\n\n\n\n::: {.cell hash='within_between_cache/html/unnamed-chunk-14_33808790c850e39ea518c4339713870e'}\n\n```{.r .cell-code}\n# hausman test manually\n\nhaus_contr <- cbind(c(0, -1, 1))\nhaus_mean <- fixef(fev_wb) %*% haus_contr\nhaus_var <- t(haus_contr) %*% vcov(fev_wb) %*% haus_contr\nhaus_z <- haus_mean / sqrt(haus_var)[1]\npchisq(haus_z^2, 1, lower.tail = FALSE) # p = .84\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n          [,1]\n[1,] 0.8412728\n```\n:::\n\n```{.r .cell-code}\n# hausman with plm\n\n# phtest(y~age, data = fev_centered, index = c(\"id\"))\nwi <- plm(y~age, data = fev_centered, index = c(\"id\"), model = \"within\" )\nfe <- plm(y~age, data = fev_centered, index = c(\"id\"), model = \"between\")\nmi <- plm(y~age, data = fev_centered, index = c(\"id\"), model = \"random\")\n\nphtest(wi, mi)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n\tHausman Test\n\ndata:  y ~ age\nchisq = 0.042027, df = 1, p-value = 0.8376\nalternative hypothesis: one model is inconsistent\n```\n:::\n:::\n\n\n## Resources\n\n- [Separation of individual-level and cluster-level covariate effects in regression analysis of correlated data](https://onlinelibrary-wiley-com.ezproxy.library.wisc.edu/doi/pdfdirect/10.1002/sim.1524)\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}