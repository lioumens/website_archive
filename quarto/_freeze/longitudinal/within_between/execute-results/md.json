{
  "hash": "5d613d2c1771aba4496e1b4ea0cbae08",
  "result": {
    "markdown": "---\ntitle: \"within between model\"\nauthor: \"Michael\"\nformat: docusaurus-md\nexecute:\n  cache: true\n---\n\n::: {.cell hash='within_between_cache/markdown_strict/unnamed-chunk-1_61269b70285139568ac62b6eabc3dac9'}\n\n```{.r .cell-code  code-fold=\"true\" code-summary=\"Load Libraries\"}\nlibrary(tidyverse)\nlibrary(nlme)\nlibrary(lme4)\nlibrary(palmerpenguins)\nlibrary(plm)\n\ndata(penguins)\n```\n:::\n\n\n# Introduction\n\nThis material is largely sourced from Chapter 9 of Longitudinal Data Analysis.\n\nFor fixed effects models,\n\n- $X_{ij}$ is independent of $\\varepsilon_{ij}$ and $\\varepsilon_{ij'}$.\n  - an observation will not help determine the value of the next\n\n# Within-Between\n\n\n::: {.cell hash='within_between_cache/markdown_strict/unnamed-chunk-2_691064a7803cf5b2abcbb52caab5ddf1'}\n\n```{.r .cell-code}\n# simulated  \ndat_skel <- data.frame(cohort = rep(1:3, each = 16),\n           id = rep(1:12, each = 4),\n           age = c(rep(c(4, 6, 7, 10), 4), # cohort 1\n                   rep(c(4, 5, 8, 9) + 1, 4), # cohort 2 \n                   rep(c(4, 7, 8, 10) + 2, 4))) # cohort 3\n# creating data\nset.seed(1)\nid_int <- rnorm(12, 2) + 10\nid_slope <- rnorm(12, mean = 1, sd = .01) # random slope\ncohort_int <- c(1, 4, 7)\n\ndat <- dat_skel %>% \n  mutate(y = id_int + id_slope * age + cohort_int[cohort] + rnorm(nrow(.), sd = 5),\n         id = factor(id),\n         cohort = factor(cohort))\n```\n:::\n\n::: {.cell hash='within_between_cache/markdown_strict/unnamed-chunk-3_8000bf6b168d99b4a6151be96ac52024'}\n\n```{.r .cell-code}\ndat %>% ggplot(aes(age, y, color = cohort, group = id)) +\n  geom_point() +\n  geom_line()\n```\n\n::: {.cell-output-display}\n![](within_between.markdown_strict_files/figure-markdown_strict/unnamed-chunk-3-1.png){width=768}\n:::\n:::\n\n::: {.cell hash='within_between_cache/markdown_strict/unnamed-chunk-4_6daa4b8a39fe4239276ab2f893e32cd2'}\n\n```{.r .cell-code}\ndat_centered <- dat %>% group_by(id) %>% \n  mutate(age_mean = mean(age),\n         y_mean = mean(y),\n         age_centered = age - age_mean,\n         y_centered = y - y_mean)\ndat_baseline <- dat %>% arrange(id, age) %>% \n  group_by(id) %>% \n  mutate(age_baseline = age - first(age),\n         y_baseline = y - first(y)) %>% \n  filter(age_baseline != 0)\n```\n:::\n\n::: {.cell hash='within_between_cache/markdown_strict/unnamed-chunk-5_b58977381617659cb404e3d51c43cb6d'}\n\n```{.r .cell-code}\n# Fixed Effect Estimate (within model)\ncentered_lm <- lm(y_centered ~ age_centered, data = dat_centered) # centered regression\n\n# between model\nbaseline_lm <- lm(y_baseline~age_baseline, data = dat_baseline) # baseline adjusted (centered)\nid_lm <- lm(y~age + id, data = dat_centered) # id model (centered)\n\nmean_lm <- lm(y_mean ~ age_mean, data = dat_centered) # mean regression (pooled model)\n\npooled_lm <- lm(y~age, data = dat_centered)\n\ncohort_lm <- lm(y~age + cohort, data = dat_centered)\n\n# mixed model\nmmod <- lmer(y ~ age + (1|id), data = dat)\n\n# within-between model\nwb_mmod <- lmer(y~age_centered + age_mean + (1 | id), data = dat_centered)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nboundary (singular) fit: see help('isSingular')\n```\n:::\n\n```{.r .cell-code}\ncbind(\n  baseline_lm = coef(baseline_lm),\n  mean = coef(mean_lm),\n  cohort = coef(cohort_lm)[1:2],\n  id = coef(id_lm)[1:2],\n  pooled = coef(pooled_lm),\n  centered = coef(centered_lm),\n  mixed = fixef(mmod)) %>% rbind(NA) %>% \n  cbind(within_between = fixef(wb_mmod))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n             baseline_lm      mean    cohort       id    pooled     centered\n(Intercept)    -0.508907 -3.670061 11.107892 9.596570 10.993983 4.411316e-16\nage_baseline    1.316630  3.640294  1.316031 1.316031  1.768289 1.316031e+00\n                      NA        NA        NA       NA        NA           NA\n                 mixed within_between\n(Intercept)  12.131986      -3.670061\nage_baseline  1.623012       1.316031\n                    NA       3.640294\n```\n:::\n:::\n\n\n$$\n\\begin{aligned}\nw = \\frac{(1 - \\rho_y)\\rho_x}{(1 - \\rho_y) + n\\rho_y(1-\\rho_x)}\n\\end{aligned}\n$$\nand \n\n$$\n\\begin{aligned}\n\\hat \\beta_2^{(RE)} = (1 - w)\\hat\\beta_2^{(FE)} + w\\hat\\beta_2^{(B)}\n\\end{aligned}\n$$\n\n\n::: {.cell hash='within_between_cache/markdown_strict/unnamed-chunk-6_61deccbd3c55bf55d5e3c12dbccfb6e1'}\n\n```{.r .cell-code}\n# help function for weight\nfixed_random_weight <- function(rho_x, rho_y, n) {\n  (1-rho_y) * rho_x / ((1-rho_y) + n * rho_y * (1 - rho_x))\n}\n```\n:::\n\n::: {.cell hash='within_between_cache/markdown_strict/unnamed-chunk-7_f79e6ef981f0dc8f298bbdc4345633e8'}\n\n```{.r .cell-code}\n# response correlation\nrho_y <- VarCorr(mmod) %>% as.data.frame() %>% pull(vcov) %>% \n  as_mapper(~.x[1]/sum(.x))()\n\n# correlation of age\nage_lm <- lm(age~id, data = dat_centered)\nrho_x <- summary(age_lm)$r.squared\n\nn <- 4\nw <- fixed_random_weight(rho_x, rho_y, n)\n(1-w) * fixef(wb_mmod)[2] + w * fixef(wb_mmod)[3]\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nage_centered \n    1.623012 \n```\n:::\n:::\n\n::: {.cell hash='within_between_cache/markdown_strict/unnamed-chunk-8_581c1cfc39003115813250e5ff6ade50'}\n\n```{.r .cell-code}\ndat %>% ggplot(aes(age, y, color = cohort, group = id)) +\n  geom_point(alpha = .2) +\n  geom_line(alpha = .2) +\n  geom_abline(slope = coef(centered_lm)[2], intercept = coef(centered_lm)[1] + 10) + # centered estimate\n  geom_abline(slope = coef(mean_lm)[2], intercept = coef(mean_lm)[1]) + # mean estimate\n  geom_abline(slope = fixef(mmod)[2], intercept = fixef(mmod)[1], linetype = 2) # mixed effects estimate\n```\n\n::: {.cell-output-display}\n![](within_between.markdown_strict_files/figure-markdown_strict/unnamed-chunk-8-1.png){width=768}\n:::\n:::\n\n\n\n\n\n\n# FEV example\n\n\n\n::: {.cell hash='within_between_cache/markdown_strict/unnamed-chunk-9_b3e069fe4178c7d922d8d8a0e163fdce'}\n\n```{.r .cell-code}\nlibrary(foreign)\nfev <- read.dta(\"data/fev1.dta\") %>% \n  filter(id != 197) %>%\n  mutate(id = factor(id),\n         y =  logfev1 - 2 * (log(ht)))\n\nfev_centered <- fev %>% group_by(id) %>% \n  mutate(\n    y_mean = mean(y),\n    age_mean = mean(age),\n    age_centered = age - age_mean)\n```\n:::\n\n::: {.cell hash='within_between_cache/markdown_strict/unnamed-chunk-10_7a1c2bb0b6c32e9f0da17bbff2306290'}\n\n```{.r .cell-code}\n# fitting all models\nfev_lm <- lm(y ~ age + id, data = fev) # lm\nfev_mer <- lmer(y~age + (1|id), data = fev) # random\n\n# within/between model\nfev_wb <- lmer(y ~ age_centered + age_mean + (1|id),\n               data = fev_centered,\n               REML = FALSE)\n\n# cross sectional\nfev_mean_lm <- lm(y_mean ~ age_mean, data = fev_centered)\n\n\n# age correlation (between/within)\nfev_age_lm <- lm(age ~ id, data = fev)\n```\n:::\n\n::: {.cell hash='within_between_cache/markdown_strict/unnamed-chunk-11_b4c18f4cb12c6f637fcd62acb17458f1'}\n\n```{.r .cell-code}\n# comparing the coefficients\ncbind(fixed = coef(fev_lm)[1:2],\n      random = fixef(fev_mer),\n      mean = coef(fev_mean_lm)) %>% \n  rbind(NA) %>% cbind(within_between = fixef(fev_wb))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                  fixed      random        mean within_between\n(Intercept) -0.39873981 -0.35517115 -0.37154929    -0.34833979\nage          0.02982264  0.02980696  0.03109488     0.02982264\n                     NA          NA          NA     0.02923539\n```\n:::\n:::\n\n::: {.cell hash='within_between_cache/markdown_strict/unnamed-chunk-12_82a478efc4a0e0a24a5ae4611872c104'}\n\n```{.r .cell-code}\nrho_y <- VarCorr(fev_mer) %>% \n  as.data.frame() %>%\n  pull(vcov) %>%\n  as_mapper(~.x[1]/sum(.x))() # .689\n\n# age covariance\n# fev_age_ss <- anova(fev_age_lm)$`Sum Sq`\n# rho_x <- fev_age_ss[1] / sum(fev_age_ss) \nrho_x <- summary(fev_age_lm)$r.squared # .172\n\nnbar <- fev %>% count(id) %>% pull(n) %>% mean()\n\nw <- fixed_random_weight(rho_x, rho_y, nbar)\nw\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0.01297669\n```\n:::\n:::\n\n\nSince this value of w is very low we expect that the mixed estimate is very close to the fixed estimate.\n\n\n\n::: {.cell hash='within_between_cache/markdown_strict/unnamed-chunk-13_14eb724202aa00ad7100779167d29472'}\n\n```{.r .cell-code}\n# hausman test manually\n\nhaus_contr <- cbind(c(0, -1, 1))\nhaus_mean <- fixef(fev_wb) %*% haus_contr\nhaus_var <- t(haus_contr) %*% vcov(fev_wb) %*% haus_contr\nhaus_z <- haus_mean / sqrt(haus_var)[1]\npchisq(haus_z^2, 1, lower.tail = FALSE) # p = .84\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n          [,1]\n[1,] 0.8412728\n```\n:::\n\n```{.r .cell-code}\n# hausman with plm\n\n# phtest(y~age, data = fev_centered, index = c(\"id\"))\nwi <- plm(y~age, data = fev_centered, index = c(\"id\"), model = \"within\" )\nfe <- plm(y~age, data = fev_centered, index = c(\"id\"), model = \"between\")\nmi <- plm(y~age, data = fev_centered, index = c(\"id\"), model = \"random\")\n\nphtest(wi, mi)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n\tHausman Test\n\ndata:  y ~ age\nchisq = 0.042027, df = 1, p-value = 0.8376\nalternative hypothesis: one model is inconsistent\n```\n:::\n:::\n\n\n# Resources\n\n- [Separation of individual-level and cluster-level covariate effects in regression analysis of correlated data](https://onlinelibrary-wiley-com.ezproxy.library.wisc.edu/doi/pdfdirect/10.1002/sim.1524)\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}