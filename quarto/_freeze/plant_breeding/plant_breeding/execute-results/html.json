{
  "hash": "7d0a625b680b4cddce8bf0bf3d85353b",
  "result": {
    "markdown": "---\ntitle: \"Plant Breeding\"\nauthor: \"Michael Liou\"\ndate: \"2/25/2022\"\nexecute:\n  cache: true\n---\n\n::: {.cell hash='plant_breeding_cache/html/unnamed-chunk-1_437a21754c88a4bfb219afaa384141f8'}\n\n```{.r .cell-code  code-summary=\"Libraries\"}\nlibrary(tidyverse)\nlibrary(agricolae)\nlibrary(magrittr)\nlibrary(scales)\nlibrary(gge)\n```\n:::\n\n\n# Plant Breeding Introduction\n\nThe motivation for many plant breeding programs is to identify a particular variety/strain/genotype \n\n## Terminology\n\nThere are several names loosely related to *genotype* in plant breeding:\n\n* **variety** - normally used to divide plant types\n* **cultivar** - used similarly to variety\n* **species** - taxonomic categorization which are reproductively isolated from one another. Often broader than variety.\n* **strain** - informal taxonomic division, generally used as a subdivision of species\n* **genotype** - used commonly when referencing specifically genomic distinguished characteristics.\n* **accession** - accession numbers are assigned like an ID code by people that maintain or curate a set of plants or crops. The analogy is that it's a call number for their library. For example, the USDA Agricultural Research Station has a library of crops that they maintain, and their system for assigning accession numbers is detailed in [a directive](https://directives.sc.egov.usda.gov/viewDirective.aspx?hid=27310). One of their goals is to help facilitate the discovery of better plants, you can read the full [mission statement here](https://www.ars.usda.gov/midwest-area/ames/plant-introduction-research/) and list of plants they have [curated in their library](https://www.ars.usda.gov/midwest-area/ames/plant-introduction-research/home/curators/page-1/).\n\n\n## Additional Resources\n\n* A [great glossary of plant germplasm terms](https://www.nap.edu/read/1583/chapter/8)\n\n# AMMI\n\nAMMI stands for Additive Main Effects and Multiplicative Interaction models and have been used to analyze main effects and genotype by environment interactions in multilocation variety trials.\n\nConsider the anova of genotype (G) the environment (E) and their interaction (GE),\n\n$$\n\\begin{aligned}\nY_{ijk} = G_i + E_j + GE_{ij} + \\varepsilon_{ijk}\n\\end{aligned}\n$$\n\nThere are a few downsides to this ANOVA, in that GE is not sufficiently explored. AMMI breaks down the GE interaction into orthogonal components and tests each of the orthogonal components with svd, that is,\n\n$$\n\\begin{aligned}\nY_{ijk} = G_i + E_j + \\sum_{n=1}^{h}u_{ni}s_nv_{in} + \\varepsilon_{ijk}\n\\end{aligned}\n$$\nwhere $s_n$ is the n'th singular value, $u_{ni}$ is the nth left singular vector, $v_{in}$ is the $n^{th}$ right singular vector.\n\n## Example and Breakdown of AMMI\n\nThe example from the documetation is `plrv`, which we will use and replicate results for\n\n\n::: {.cell hash='plant_breeding_cache/html/unnamed-chunk-2_6e69e33d618a0b937495e64e95499ea0'}\n\n```{.r .cell-code}\ndata(plrv)\nhead(plrv)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n  Genotype Locality Rep WeightPlant WeightPlot    Yield\n1   102.18     Ayac   1   0.5100000       5.10 18.88889\n2   104.22     Ayac   1   0.3450000       2.76 12.77778\n3   121.31     Ayac   1   0.5425000       4.34 20.09259\n4   141.28     Ayac   1   0.9888889       8.90 36.62551\n5   157.26     Ayac   1   0.6250000       5.00 23.14815\n6    163.9     Ayac   1   0.5120000       2.56 18.96296\n```\n:::\n:::\n\n\n### ANOVA\n\nanova with rep nested in location.\n\n\n::: {.cell hash='plant_breeding_cache/html/unnamed-chunk-3_2ac6facc7aecb2b0adfdc7ce748b80ff'}\n\n```{.r .cell-code}\n# AMMI\nplrv <- plrv %>% mutate(Rep = factor(Rep))\nmod_ammi <- with(plrv, AMMI(Locality, Genotype, Rep, Yield, console = FALSE))\nmod_ammi$ANOVA\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAnalysis of Variance Table\n\nResponse: Y\n           Df Sum Sq Mean Sq  F value    Pr(>F)    \nENV         5 122284 24456.9 257.0382  9.08e-12 ***\nREP(ENV)   12   1142    95.1   2.5694  0.002889 ** \nGEN        27  17533   649.4  17.5359 < 2.2e-16 ***\nENV:GEN   135  23762   176.0   4.7531 < 2.2e-16 ***\nResiduals 324  11998    37.0                       \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n::: {.cell hash='plant_breeding_cache/html/unnamed-chunk-4_fb8af7b2187ee8b63bd8bcf814c8e3c6'}\n\n```{.r .cell-code}\n# The same anova table by lm\n# mod_plrv <- lm(Yield~Genotype*Locality +  Rep:Locality, data = plrv) # same\nmod_plrv <- lm(Yield~Genotype*Locality +  Rep %in% Locality, data = plrv)\nanova(mod_plrv)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAnalysis of Variance Table\n\nResponse: Yield\n                   Df Sum Sq Mean Sq  F value    Pr(>F)    \nGenotype           27  17533   649.4  17.5359 < 2.2e-16 ***\nLocality            5 122284 24456.9 660.4343 < 2.2e-16 ***\nGenotype:Locality 135  23762   176.0   4.7531 < 2.2e-16 ***\nLocality:Rep       12   1142    95.1   2.5694  0.002889 ** \nResiduals         324  11998    37.0                       \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n\n## genXenv\n\nThese are residuals from the regression of only gen and env main effects.\n\n\n::: {.cell hash='plant_breeding_cache/html/unnamed-chunk-5_ca1b8b05581b45d779ee8f7bfd123aa1'}\n\n```{.r .cell-code}\n# AMMI version\nmod_ammi$genXenv %>% head()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n        ENV\nGEN             Ayac     Hyo-02     LM-02      LM-03       SR-02      SR-03\n  102.18   5.5726162 -12.491822  1.742525  -2.707044   2.9173487  4.9663762\n  104.22  -2.8712076   7.168410  3.933622  -4.035837   0.4788158 -4.6738028\n  121.31   0.3255230  -3.866684  4.318281  10.436613 -11.8834384  0.6697043\n  141.28  -0.9451837   5.645482 -9.780664  14.646310  -4.8033711 -4.7625741\n  157.26 -10.3149711 -10.624168  4.233636  16.868361   2.7171021 -2.8799609\n  163.9    3.0874931  -6.941672  3.496379 -12.553327   7.0168816  5.8942454\n```\n:::\n:::\n\n::: {.cell hash='plant_breeding_cache/html/unnamed-chunk-6_f3f8386da35cdf58efbaa01496fa1e93'}\n\n```{.r .cell-code}\n# by hand\nmean_plrv <- plrv %>% group_by(Genotype, Locality) %>% \n  summarize(Yield = mean(Yield), .groups = \"drop_last\") %>% \n  add_column(residuals = lm(Yield~Genotype + Locality, data = .)$residuals)\n\nplrv_int <- mean_plrv %>% pivot_wider(id_cols = \"Genotype\", names_from = \"Locality\", values_from = \"residuals\")\nplrv_int %>% head()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 6 Ã— 7\n# Groups:   Genotype [6]\n  Genotype    Ayac `Hyo-02` `LM-02` `LM-03` `SR-02` `SR-03`\n  <fct>      <dbl>    <dbl>   <dbl>   <dbl>   <dbl>   <dbl>\n1 102.18     5.57    -12.5     1.74   -2.71   2.92    4.97 \n2 104.22    -2.87      7.17    3.93   -4.04   0.479  -4.67 \n3 121.31     0.326    -3.87    4.32   10.4  -11.9     0.670\n4 141.28    -0.945     5.65   -9.78   14.6   -4.80   -4.76 \n5 157.26   -10.3     -10.6     4.23   16.9    2.72   -2.88 \n6 163.9      3.09     -6.94    3.50  -12.6    7.02    5.89 \n```\n:::\n:::\n\n\n## SVD\n\n\n\n::: {.cell hash='plant_breeding_cache/html/unnamed-chunk-7_076c6fd77cf4cf3d457424ec39ff48fd'}\n\n```{.r .cell-code}\n# AMMI version\nmod_ammi$analysis\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n    percent  acum Df     Sum.Sq   Mean.Sq F.value   Pr.F\nPC1    56.3  56.3 31 13368.5954 431.24501   11.65 0.0000\nPC2    27.1  83.3 29  6427.5799 221.64069    5.99 0.0000\nPC3     9.4  92.7 27  2241.9398  83.03481    2.24 0.0005\nPC4     4.3  97.1 25  1027.5785  41.10314    1.11 0.3286\nPC5     2.9 100.0 23   696.1012  30.26527    0.82 0.7059\n```\n:::\n:::\n\n::: {.cell hash='plant_breeding_cache/html/unnamed-chunk-8_368ca0f8edfca32c5b14d0e4deee82b0'}\n\n```{.r .cell-code}\n# by hand\nplrv_mat <- plrv_int %>% data.matrix() %>% `[`(,-1)\n\ns <- svd(plrv_mat)\nU <- s$u\nL <- s$d\nV <- s$v\n\n# sum of squares for each orthogonal component is simply sum(singular values^2). We multiply by 3 because we averaged over 3 reps\nSS <- (L^2) * 3\nscales::number(SS, big.mark = \"\", accuracy = .001)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"13368.595\" \"6427.580\"  \"2241.940\"  \"1027.579\"  \"696.101\"   \"0.000\"    \n```\n:::\n:::\n\n\nthe sum of squares, is because the frobenius norm is invariant to unitary changes, thus, the SVD, $U$ and $V$ matrices don't affect the norm, and we can just calculate frobenius norm of the singular values. See proof on site [facts of unitary invariant norms](https://nhigham.com/2021/02/02/what-is-a-unitarily-invariant-norm/)\n\n\n\n::: {.cell hash='plant_breeding_cache/html/unnamed-chunk-9_dc56cc0e9be3fecaa032cfbec2c1f46f'}\n\n```{.r .cell-code}\n# total is the same as SS of the GE in the anova table\nSSTotal <- sum(SS, na.rm = TRUE)\npercent <- (1/SSTotal) * SS * 100\n\n# percent is just the ratio to total.\nscales::number(percent, accuracy = .01)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"56.26\" \"27.05\" \"9.44\"  \"4.32\"  \"2.93\"  \"0.00\" \n```\n:::\n:::\n\n\nThe formula for degrees of freedom is\n\n$$\n\\begin{aligned}\ndf_n = i + j - 1 - 2m\n\\end{aligned}\n$$\n\nwhere $i$ is number of genotypes, $j$ is number of environments, and $m$ is how many components you choose.\n\nnot sure the derivation, but details should be in:\n\n- Zobel, R. W., Wright, M.J., and Gauch, H. G. (1988). Statistical analysis of a yield trial. Agronomy Journal, 388-393.\n\n\n\n::: {.cell hash='plant_breeding_cache/html/unnamed-chunk-10_66332f5a5c0196052b53de8b16c4c779'}\n\n```{.r .cell-code}\n# df in table \n28 + 6 - 1 - 2*(1:5)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 31 29 27 25 23\n```\n:::\n:::\n\n::: {.cell hash='plant_breeding_cache/html/unnamed-chunk-11_c91e0d48f06abae1b87b3007bf2b460e'}\n\n```{.r .cell-code}\n# mean squares of residual from anova table\nSSres <- 37.0 # df = 31\n\n# F = MS / MSres, df from the tables and formulas\n1 - pf(431.24501 / 37, 31, 31)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 4.109519e-10\n```\n:::\n:::\n\n\n## Biplots\n\nbiplots are just principal components.\n\n# GGE\n\nGGE stands for \"Genotype + Genotype:Environment\" biplot analysis. There is additional specification for \"block\" or grouping structures among different environments (locations or years typically),\n\n## crossa.wheat example\n\nWe use the crossa wheat example to see how the method works. see `?crossa.wheat` for details.\n\n\n::: {.cell hash='plant_breeding_cache/html/unnamed-chunk-12_84c3a6b0f50030d1523026302f38303e'}\n\n```{.r .cell-code}\ndata(crossa.wheat)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in data(crossa.wheat): data set 'crossa.wheat' not found\n```\n:::\n:::\n\n::: {.cell hash='plant_breeding_cache/html/unnamed-chunk-13_403130a79d333b825bade91bc56b0cff'}\n\n```{.r .cell-code}\nlibrary(agridat)\ndata(crossa.wheat)\nm1 <- gge(crossa.wheat, yield ~ gen*loc , env.group=locgroup, scale=FALSE, ggb = TRUE)\nplot(m1)\n```\n\n::: {.cell-output-display}\n![](plant_breeding_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n\n```{.r .cell-code}\nbiplot(m1)\n```\n\n::: {.cell-output-display}\n![](plant_breeding_files/figure-html/unnamed-chunk-13-2.png){width=672}\n:::\n:::\n\nPlot explanations:\n\n- **The proportion explained plot** - is just the ratio of singular values squared\n- **Raster** - is showing the heatmap of probably the residuals after regression on G + G:E i think?\n- **biplot** - first two principal components with vectors for each environment.\n\n## plrv example (reproduction)\n\nWe use the plrv example to try and recreate the components of the GGE analysis\n\n\n::: {.cell hash='plant_breeding_cache/html/unnamed-chunk-14_3d7a807019e23b13c02428b2c57e68f3'}\n\n```{.r .cell-code}\nm2 <- gge(plrv, formula = Yield~Genotype*Locality, center=TRUE, scale = TRUE)\nm2 %>% names()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n [1] \"x\"          \"x.orig\"     \"genCoord\"   \"locCoord\"   \"blockCoord\"\n [6] \"gen.group\"  \"env.group\"  \"ggb\"        \"genMeans\"   \"mosdat\"    \n[11] \"R2\"         \"center\"     \"scale\"      \"method\"     \"pctMiss\"   \n[16] \"maxPCs\"    \n```\n:::\n:::\n\n::: {.cell hash='plant_breeding_cache/html/unnamed-chunk-15_608be39d772e449c471a59e19460c4a2'}\n\n```{.r .cell-code}\n# x.orig is the means grouped by genotype and locality, first dimension is genotype\nx.orig <- plrv %>% group_by(Genotype, Locality) %>% \n  summarize(mean_yield = mean(Yield), .groups = \"drop_last\") %>% \n  pivot_wider(id_cols = \"Genotype\", names_from = \"Locality\", values_from = \"mean_yield\") %>% \n  data.matrix() %>% \n  `[`(,-1)\n\n# gge$x is center scaled matrix\nx <- x.orig %>% scale()\n```\n:::\n\n\n\n::: {.cell hash='plant_breeding_cache/html/unnamed-chunk-17_a7a4d6040aa3864145dfeff48814cee3'}\n\n```{.r .cell-code}\n# genMeans is just average across all the environments\ngenMeans <- rowMeans(x, na.rm = TRUE)\n# genMeans %*% t(rep(1, ncol(x)))\n```\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}