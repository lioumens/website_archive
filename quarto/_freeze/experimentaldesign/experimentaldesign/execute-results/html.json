{
  "hash": "938f67ace95868532f84b90d82b6200e",
  "result": {
    "markdown": "---\ntitle: \"Experimental Design\"\ndate: \"2/4/2022\"\nauthor: \"Michael Liou\"\nexecute:\n  cache: true\n---\n\n\n\n\n# Introduction\n\n## Definitions\n\nTypes of units in Design and Analysis of Experiments (DOE)\n\n- **Experimental Unit (EU)** - the smallest unit to which a treatment is applied. Experiments can have more than one experimental unit when studying more than one treatment factor. This results in split-plot designs.\n- **Sampling Unit** - A unit that makes up the population to be modeled. Sampling units are used to make observations. \n- **Observational Unit** - The unit from which an observation is made.\n\nTypes of factors in DOE\n\n- **Treatment** - normally a factor of interest to the experimentor.\n- **Blocking** - also regarded as a factor, but a known source of variation. This differs from treatment factor in that it CHANGES THE RANDOMIZATION of the experiement.\n\nA note on the word replication, I try to avoid this word, as it is *heavily* abused and vague. Sometimes clients mean subsamples, sometimes they mean a blocking factor, sometimes they mean experimental units. \"I replicated this experiment 3 times\". If they replicated it over years, this would imply blocking in time. \"I have 3 replicates of data\", implies they may have 3 data points from the same experimental unit.\n\nAnother note on \"blocking\": Blocking is a design mechanism of efficiency that stems from the REAL WORLD, not mathematics. Clients often come with \"blocked\" experiments because they believe that just including block will make the design more efficient. \"Why did you block on this variable?\" \"blocking is more efficient and I had extra samples\". If you don't block on anything useful, it will actually make the design less efficient, and you're better off with a CRD.\n\n### Examples for definitions\n\n* Students in classroom\n  - Suppose we're studying methods of teaching (treatment factor) on student achievement. The experimental unit is a classroom, because the teaching method is applied to the whole classroom. A sampling unit is a student from that classroom, and the observational unit is some test score of the student, or some measured response from the student.\n* Plants in a field\n  - When we study a fertilizer (treatment factor) on the health of a plant, we are likely not just planting 1 plant, but many in a row for which fertilizer is applied. The row is the experimental unit, a plant is the sampling unit, and the observational unit is making some measurement like root length on that plant.\n\n## Fischer Principles of Design\n\n1. Randomization - necessary for validity of error variance estimates.\n2. Replication - allows for an estimate of variance.\n3. Blocking (stratification) - allows for efficient experimentation\n\n\n# Hasse Diagrams\n\n1. start with M term on top, stands for grand mean\n2. next row is all factors not nested in any term, all lines up to M.\n3. nested factors go directly below what it's nested in\n4. draw nodes for all interaction terms from above\n\n# Two Way Anova\n\n$$\n\\begin{aligned}\nY_{ijk} = \\alpha_i + \\beta_j + \\varepsilon_{ijk}\n\\end{aligned}\n$$\n\n## Fitted values and Group Means\n\nThe purpose of this section was an experiement following doing a Finley-Wilkenson regression for a client, in which I was considering calculating multiple ways of calculating the \"environmental index\". The point here is a little subtle: **The fitted values from a two-way anova model are not the same as the raw calculated grouped means**. The upshot of this statement is that (ignoring the replication) $\\hat\\alpha_1 + \\hat\\beta_1 = \\bar{y}_{1.} + \\bar{y}_{.1} \\neq y_{11}$. (The statement is somewhat adhoc, without defining contrasts estimate, but this is the cell means encoding).\n\nAfter looking at this, it's obvious, but the fact that in simple linear regression models, the fitted line goes through the mean, and even in one way anova models, the fitted values are directly the cell means. I just forgot the fact that this changes with two way models.\n\nImagine the following ways we could slice this problem\n\n- calculating the raw means by group. \n- calculating the fitted values by two way anova w/o interaction\n- calculating the fitted values by one way anova w/ interaction\n- fitting several one-way linear models subsetting the data into groups over the other level\n\n\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-1_0eb6130e284bab41ff12912f683c124a'}\n\n```{.r .cell-code}\ndata(\"oats\", package = \"MASS\")\n# calculate raw means\nraw_mean <- oats %>% group_by(V, N) %>% \n  summarize(mean_Y = mean(Y)) %>% arrange(V, N)\n\n# additive\nmod <- lm(Y ~ V + N, data = oats)\nemm <- emmeans(mod, specs = c(\"V\", \"N\"))\nadditive_mean <- emm %>% \n  as.data.frame() %>% \n  select(V, N, emmean) %>% \n  arrange(V, N)\n\n# additive with interaction\nmod2 <- lm(Y ~ V + N + V:N, data = oats)\nemm2 <- emmeans(mod, specs = c(\"V\", \"N\"))\n\ninter_mean <- emm2 %>% as.data.frame() %>% select(V,N,emmean) %>% arrange(V,N)\n\n# several one-way linear models\nmod_list <- lmList(Y~ N | V, data = oats)\nnew_dat <- oats %>% distinct(V, N) %>% arrange(V, N)\nlist_mean <- new_dat %>% \n  add_column(fitted = predict(mod_list, newdata = new_dat))\n\n# Manual construction of fitted from marginal means\nN_means <- oats %>% group_by(N) %>% summarize(N_mean = mean(Y)) %>% as.data.frame()\nV_means <- oats %>% group_by(V) %>% summarize(V_mean = mean(Y)) %>% as.data.frame()\noverall_mean <- oats %>% pull(Y) %>% mean()\n# calculate y_i. + y_.j - y_.. for all ij\nmanual_mean <- N_means %>% \n  crossing(V_means) %>% \n  mutate(fitted = N_mean + V_mean - overall_mean) %>% \n  arrange(V, N)\n\nbind_cols(new_dat,\n          tibble(raw = raw_mean$mean_Y,\n                 additive = additive_mean$emmean,\n                 interaction = inter_mean$emmean,\n                 subset_oneway = list_mean$fitted,\n                 manual_fitted = manual_mean$fitted))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n             V      N       raw  additive interaction subset_oneway\n1  Golden.rain 0.0cwt  80.00000  79.91667    79.91667      80.00000\n2  Golden.rain 0.2cwt  98.50000  99.41667    99.41667      98.50000\n3  Golden.rain 0.4cwt 114.66667 114.75000   114.75000     114.66667\n4  Golden.rain 0.6cwt 124.83333 123.91667   123.91667     124.83333\n5   Marvellous 0.0cwt  86.66667  85.20833    85.20833      86.66667\n6   Marvellous 0.2cwt 108.50000 104.70833   104.70833     108.50000\n7   Marvellous 0.4cwt 117.16667 120.04167   120.04167     117.16667\n8   Marvellous 0.6cwt 126.83333 129.20833   129.20833     126.83333\n9      Victory 0.0cwt  71.50000  73.04167    73.04167      71.50000\n10     Victory 0.2cwt  89.66667  92.54167    92.54167      89.66667\n11     Victory 0.4cwt 110.83333 107.87500   107.87500     110.83333\n12     Victory 0.6cwt 118.50000 117.04167   117.04167     118.50000\n   manual_fitted\n1       79.91667\n2       99.41667\n3      114.75000\n4      123.91667\n5       85.20833\n6      104.70833\n7      120.04167\n8      129.20833\n9       73.04167\n10      92.54167\n11     107.87500\n12     117.04167\n```\n:::\n:::\n\n\nLooking at the output, additive and interaction models don't change the estimated marginal means. The one-way with subset matches the raw mean values by group because those one way models will go through the mean, and thus, fitting them seperately will those results. The Manual way of fitting calculated marginal means by Variety and Nitrogen separately, and then adds them in an \"outer\" type fashion.\n\n\n# Blocking Designs\n\nAt its core, one should understand the features of a two way anova in order to understand what blocking does to the covariate.\n\n## Randomized Complete Block Design (RCBD)\n\nSummary\n\n- RCBD's assume that the blocking factor is *additive*. That might be a wrong assumption.\n\n$$\n\\begin{aligned}\nY_{ij} = \\alpha_i + b_j + \\varepsilon_{i(j)}\n\\end{aligned}\n$$\n\n\n- $Y_ij$ - is observation at $i$th treatment level\n- $\\alpha_i$ - is treatment effect for level $i$\n- $b_j$ - is block effect of $j$\n- $\\varepsilon_{i(j)}$ - is surrogate error term, assuming $\\varepsilon_{i(j)} \\sim N(0, \\sigma^2)$\n\n<div style=\"display:flex;justify-content:center\">\n<img style=\"width:70%\" src=\"assets/img/RCBD.png\"/>\n<img style=\"width:25%\" src=\"assets/img/rcbd_table.png\"/>\n</div>\n\n\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-2_1ac3efbe90781d5d3c352b51acdf3052'}\n\n:::\n\n\n\n\n\n## Generalized Randomized Block Design (GRBD)\n\n$$\n\\begin{aligned}\nY_{ij} = \\alpha_i + b_j + \\alpha b_{ij} + \\varepsilon_{k(ij)}\n\\end{aligned}\n$$\n\n* $Y_ij$ - is observation at $i$th treatment level, \n* $\\alpha_i$ - is treatment effect for level $i$, $i = 1 \\dots a$\n* $b_j$ - is block effect of $j$, $j = 1 \\dots b$\n* $\\alpha b_{ij}$ - is interaction effect of treatment and block.\n* $\\varepsilon_{k(ij)}$ - is error term, assuming $\\varepsilon_{k(ij)} \\sim N(0, \\sigma^2)$\n\n\n<div style=\"display:flex;justify-content:center;align-items:start\">\n<img style=\"width:70%\" src=\"assets/img/GRBD.png\"/>\n<img style=\"width:25%\" src=\"assets/img/grbd_table.png\"/>\n</div>\n\n\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-3_3219c0e67676312b9bf61b620535e2b7'}\n\n:::\n\n\nWithin a single block, there is a replicate of the treatment. As opposed to a RCBD in which each level of the treatment has 1 experimental unit.\n\n## Blocking Resources\n\n- [Gary Lecture Notes](http://users.stat.umn.edu/~gary/classes/5303/lectures/Blocking.pdf)\n\n# Split Plot Designs\n\nThe classic split plot design presented in most textbooks is one in which the whole plot experimental units (wpeu) treated by factor $A$ (with $a$ levels)  have $r$ replications (either in the form of block replicates or identical replicates), and the sub-plot experimental units (speu) is completely randomized _within_ the whole plot.\n\nThe defining feature of split plot designs is that there are multiple sizes of experimental units.\n\n<img style=\"width:70%\" src=\"assets/img/split_plot_table.png\"/>\n\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-4_0ae5a4dc6652831b9611c6ce0884df2d'}\n\n:::\n\n\n\n<img style=\"width:70%\" src=\"assets/img/split_plot_block_table.png\"/>\n\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-5_d9c2567e46bf3446f48409314c00e9ff'}\n\n:::\n\n\n## Oats Example \n\nThis is normally analyzed as 1 factor RCBD in whole plot, 1 factor RCD in subplot. We will use this example in two ways, the simple way in which we ignore the blocking factor, and the natural way with the blocking factor.\n\n- `B` - Blocks (6 whole plots)\n- `V` - Varieties (3 levels, whole plot factor)\n- `N` - Nitrogen (4 levels, sub plot factor)\n- `Y` - Yields in 1/4 acre (from subplot)\n\n<center>\n<img style=\"width:70%\" src=\"assets/img/oats.png\"/>\n<figcaption> Figure: This image shows 2 out of the 6 blocks (as rows) of the experiment. </figcaption>\n</br>\n</center>\n\n\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-6_9aa8656c87d5eb85fc3a2a41e909b11c'}\n\n:::\n\n::: {.cell rows.print='5' rownames.print='false' hash='experimentaldesign_cache/html/unnamed-chunk-7_24d11dde445580c0ea75890bf453d408'}\n::: {.cell-output .cell-output-stdout}\n```\n   yield     variety nitrogen block field123 field\n1    111     Victory   0.0cwt     I        1     1\n2    130     Victory   0.2cwt     I        1     1\n3    157     Victory   0.4cwt     I        1     1\n4    174     Victory   0.6cwt     I        1     1\n5    117 Golden.rain   0.0cwt     I        2     2\n6    114 Golden.rain   0.2cwt     I        2     2\n7    161 Golden.rain   0.4cwt     I        2     2\n8    141 Golden.rain   0.6cwt     I        2     2\n9    105  Marvellous   0.0cwt     I        3     3\n10   140  Marvellous   0.2cwt     I        3     3\n11   118  Marvellous   0.4cwt     I        3     3\n12   156  Marvellous   0.6cwt     I        3     3\n13    61     Victory   0.0cwt    II        1     4\n14    91     Victory   0.2cwt    II        1     4\n15    97     Victory   0.4cwt    II        1     4\n16   100     Victory   0.6cwt    II        1     4\n17    70 Golden.rain   0.0cwt    II        2     5\n18   108 Golden.rain   0.2cwt    II        2     5\n19   126 Golden.rain   0.4cwt    II        2     5\n20   149 Golden.rain   0.6cwt    II        2     5\n21    96  Marvellous   0.0cwt    II        3     6\n22   124  Marvellous   0.2cwt    II        3     6\n23   121  Marvellous   0.4cwt    II        3     6\n24   144  Marvellous   0.6cwt    II        3     6\n25    68     Victory   0.0cwt   III        1     7\n26    64     Victory   0.2cwt   III        1     7\n27   112     Victory   0.4cwt   III        1     7\n28    86     Victory   0.6cwt   III        1     7\n29    60 Golden.rain   0.0cwt   III        2     8\n30   102 Golden.rain   0.2cwt   III        2     8\n31    89 Golden.rain   0.4cwt   III        2     8\n32    96 Golden.rain   0.6cwt   III        2     8\n33    89  Marvellous   0.0cwt   III        3     9\n34   129  Marvellous   0.2cwt   III        3     9\n35   132  Marvellous   0.4cwt   III        3     9\n36   124  Marvellous   0.6cwt   III        3     9\n37    74     Victory   0.0cwt    IV        1    10\n38    89     Victory   0.2cwt    IV        1    10\n39    81     Victory   0.4cwt    IV        1    10\n40   122     Victory   0.6cwt    IV        1    10\n41    64 Golden.rain   0.0cwt    IV        2    11\n42   103 Golden.rain   0.2cwt    IV        2    11\n43   132 Golden.rain   0.4cwt    IV        2    11\n44   133 Golden.rain   0.6cwt    IV        2    11\n45    70  Marvellous   0.0cwt    IV        3    12\n46    89  Marvellous   0.2cwt    IV        3    12\n47   104  Marvellous   0.4cwt    IV        3    12\n48   117  Marvellous   0.6cwt    IV        3    12\n49    62     Victory   0.0cwt     V        1    13\n50    90     Victory   0.2cwt     V        1    13\n51   100     Victory   0.4cwt     V        1    13\n52   116     Victory   0.6cwt     V        1    13\n53    80 Golden.rain   0.0cwt     V        2    14\n54    82 Golden.rain   0.2cwt     V        2    14\n55    94 Golden.rain   0.4cwt     V        2    14\n56   126 Golden.rain   0.6cwt     V        2    14\n57    63  Marvellous   0.0cwt     V        3    15\n58    70  Marvellous   0.2cwt     V        3    15\n59   109  Marvellous   0.4cwt     V        3    15\n60    99  Marvellous   0.6cwt     V        3    15\n61    53     Victory   0.0cwt    VI        1    16\n62    74     Victory   0.2cwt    VI        1    16\n63   118     Victory   0.4cwt    VI        1    16\n64   113     Victory   0.6cwt    VI        1    16\n65    89 Golden.rain   0.0cwt    VI        2    17\n66    82 Golden.rain   0.2cwt    VI        2    17\n67    86 Golden.rain   0.4cwt    VI        2    17\n68   104 Golden.rain   0.6cwt    VI        2    17\n69    97  Marvellous   0.0cwt    VI        3    18\n70    99  Marvellous   0.2cwt    VI        3    18\n71   119  Marvellous   0.4cwt    VI        3    18\n72   121  Marvellous   0.6cwt    VI        3    18\n```\n:::\n:::\n\n::: {.cell layout-align=\"center\" hash='experimentaldesign_cache/html/unnamed-chunk-8_d8242e53fb5c787e62234ac12a918bec'}\n::: {.cell-output-display}\n![](experimentaldesign_files/figure-html/unnamed-chunk-8-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n\n### Without blocking {.tabset}\n\nHere we ignore the blocking factor. Suppose we just replicated the whole plot experimental unit a few more times. This means that we have 6 replication units for whole plot treatments, and theoretically get a better estimate for \"Variety\"\n\n[Professor Ane Factorial and Split Plot](https://pages.stat.wisc.edu/~ane/st572/notes/lec25.pdf)\n\n\nThe model for the simplest split plot design is:\n\n$$\n\\begin{aligned}\nY_{ijk} = \\alpha_i &+ \\eta_{k(i)} + \\\\\n&\\beta_j + (\\alpha\\beta)_{ij} +  \\varepsilon_{ijk}\n\\end{aligned}\n$$\nwhere:\n\n- $\\alpha$ is whole plot factor (variety)\n- $\\eta_{k(i)}$ is the whole plot error k replicates nested inside the whole plot factor\n- $\\beta_j$ - subplot factor (nitrogen)\n- $(\\alpha\\beta)_{ij}$ - interaction of whole plot factor and subplot factor\n- $\\varepsilon_{ijk}$ - split-plot level random error\n\n\n#### lm (wrong)\n\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-9_d6fd892e7b7e7701fe59620b26519dd2'}\n\n```{.r .cell-code}\n# anova table for factors for sum squares. These give identical tables.\n# oats_lm <- lm(yield~nitrogen*variety + block:variety, data = oats) # same table, different way of specifying whole plot labels\noats_lm <- lm(yield ~ nitrogen*variety + field, data = oats)\nanova(oats_lm)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAnalysis of Variance Table\n\nResponse: yield\n                 Df  Sum Sq Mean Sq F value    Pr(>F)    \nnitrogen          3 20020.5  6673.5 37.6856 2.458e-12 ***\nvariety           2  1786.4   893.2  5.0438   0.01056 *  \nfield            15 21888.6  1459.2  8.2404 1.609e-08 ***\nnitrogen:variety  6   321.7    53.6  0.3028   0.93220    \nResiduals        45  7968.7   177.1                      \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n\nNote in this table, variety is tested over the wrong denominator. It should be tested wrt to the whole plot error term.\n\n\n#### aov\n\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-10_6b1284aed3b982874e160d7db5209a37'}\n\n```{.r .cell-code}\n# aov specifying whole plot error term\n# oats_aov <- aov(yield~ nitrogen*variety + Error(block:variety), data = oats) # gives warning, but correct\noats_aov <- aov(yield ~ nitrogen*variety + Error(field), data = oats)\nsummary(oats_aov)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nError: field\n          Df Sum Sq Mean Sq F value Pr(>F)\nvariety    2   1786   893.2   0.612  0.555\nResiduals 15  21889  1459.2               \n\nError: Within\n                 Df Sum Sq Mean Sq F value   Pr(>F)    \nnitrogen          3  20020    6673  37.686 2.46e-12 ***\nnitrogen:variety  6    322      54   0.303    0.932    \nResiduals        45   7969     177                     \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\nNotice that variety has a very different p-value here when tested over the correct denominator, in contrast to the earlier `lm` table.\n\n#### aov (wrong)\n\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-11_9d0cb3dc2382a908c9b96165bc37aaf8'}\n\n```{.r .cell-code}\n# Incorrect labeling of field\noats_aov <- aov(yield~nitrogen*variety + Error(field123), data = oats)\nsummary(oats_aov)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nError: field123\n        Df Sum Sq Mean Sq\nvariety  2   1786   893.2\n\nError: Within\n                 Df Sum Sq Mean Sq F value   Pr(>F)    \nnitrogen          3  20020    6673  13.411 8.37e-07 ***\nnitrogen:variety  6    322      54   0.108    0.995    \nResiduals        60  29857     498                     \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n\nThis above table is incorrect, since we're not labeling our fields differently. We don't have appropriate replicates for variety, and thus we can't estimate the error term as we have specified.\n\n#### lmer {.active}\n\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-12_3c8c97d77de51db719bd5d585dd347fb'}\n\n```{.r .cell-code}\n# lmer way for split plot\n# oats_lmer <- lmer(yield ~ nitrogen*variety + (1|block:variety))\n# oats_lmer <- lmer(yield ~ nitrogen*variety + (1|block:field123))\noats_lmer <- lmer(yield ~ nitrogen*variety + (1|field), data = oats)\n\nsummary(oats_lmer)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nLinear mixed model fit by REML. t-tests use Satterthwaite's method [\nlmerModLmerTest]\nFormula: yield ~ nitrogen * variety + (1 | field)\n   Data: oats\n\nREML criterion at convergence: 538.2\n\nScaled residuals: \n     Min       1Q   Median       3Q      Max \n-1.83746 -0.64204  0.01107  0.61254  1.61722 \n\nRandom effects:\n Groups   Name        Variance Std.Dev.\n field    (Intercept) 320.5    17.90   \n Residual             177.1    13.31   \nNumber of obs: 72, groups:  field, 18\n\nFixed effects:\n                             Estimate Std. Error       df t value Pr(>|t|)    \n(Intercept)                  104.5000     7.7975  15.0000  13.402 9.42e-10 ***\nnitrogen.L                    33.6901     5.4327  45.0000   6.201 1.57e-07 ***\nnitrogen.Q                    -4.1667     5.4327  45.0000  -0.767    0.447    \nnitrogen.C                    -0.8199     5.4327  45.0000  -0.151    0.881    \nvarietyMarvellous              5.2917    11.0274  15.0000   0.480    0.638    \nvarietyVictory                -6.8750    11.0274  15.0000  -0.623    0.542    \nnitrogen.L:varietyMarvellous  -4.8075     7.6830  45.0000  -0.626    0.535    \nnitrogen.Q:varietyMarvellous  -1.9167     7.6830  45.0000  -0.249    0.804    \nnitrogen.C:varietyMarvellous   3.9877     7.6830  45.0000   0.519    0.606    \nnitrogen.L:varietyVictory      2.5715     7.6830  45.0000   0.335    0.739    \nnitrogen.Q:varietyVictory     -1.0833     7.6830  45.0000  -0.141    0.888    \nnitrogen.C:varietyVictory     -2.8696     7.6830  45.0000  -0.374    0.711    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nCorrelation of Fixed Effects:\n            (Intr) ntrg.L ntrg.Q ntrg.C vrtyMr vrtyVc nt.L:M nt.Q:M nt.C:M\nnitrogen.L   0.000                                                        \nnitrogen.Q   0.000  0.000                                                 \nnitrogen.C   0.000  0.000  0.000                                          \nvartyMrvlls -0.707  0.000  0.000  0.000                                   \nvarityVctry -0.707  0.000  0.000  0.000  0.500                            \nntrgn.L:vrM  0.000 -0.707  0.000  0.000  0.000  0.000                     \nntrgn.Q:vrM  0.000  0.000 -0.707  0.000  0.000  0.000  0.000              \nntrgn.C:vrM  0.000  0.000  0.000 -0.707  0.000  0.000  0.000  0.000       \nntrgn.L:vrV  0.000 -0.707  0.000  0.000  0.000  0.000  0.500  0.000  0.000\nntrgn.Q:vrV  0.000  0.000 -0.707  0.000  0.000  0.000  0.000  0.500  0.000\nntrgn.C:vrV  0.000  0.000  0.000 -0.707  0.000  0.000  0.000  0.000  0.500\n            nt.L:V nt.Q:V\nnitrogen.L               \nnitrogen.Q               \nnitrogen.C               \nvartyMrvlls              \nvarityVctry              \nntrgn.L:vrM              \nntrgn.Q:vrM              \nntrgn.C:vrM              \nntrgn.L:vrV              \nntrgn.Q:vrV  0.000       \nntrgn.C:vrV  0.000  0.000\n```\n:::\n:::\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-13_3294895443dcf4428610e9a00612c13e'}\n\n```{.r .cell-code}\n# Type III tests, here it's an exact test, so no ambiguity\n# anova(oats_lmer, ddf = \"Kenward-Roger\")\n# Anova(oats_lmer, type = \"III\", test.statistic = \"F\")\nanova(oats_lmer, ddf = \"Satterthwaite\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nType III Analysis of Variance Table with Satterthwaite's method\n                  Sum Sq Mean Sq NumDF DenDF F value    Pr(>F)    \nnitrogen         20020.5  6673.5     3    45 37.6856 2.458e-12 ***\nvariety            216.8   108.4     2    15  0.6121    0.5552    \nnitrogen:variety   321.8    53.6     6    45  0.3028    0.9322    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n\nWe note that this gives identical results as `aov`.\n\n### {- .unlisted}\n\nSince the interaction doesn't seem to be significant, we'd probably drop that term from the model and we would have the additive model as our final model for this data.\n\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-14_16dd2e89d94b1e1df51f04ff9d40b409'}\n\n```{.r .cell-code}\noats_lmer <- lmer(yield ~ nitrogen + variety + (1|field), data = oats)\n# summary(oats_lmer)\n```\n:::\n\n\n\n### With blocking {.tabset}\n\nNow that we consider blocking, the whole plot experimental unit no longer has replication. Thus, we cannot test the interaction of block and variety. Instead, we use the interaction term as the surrotate error term for whole plots. You might ask, what if I wanted to analyze the whole plot experimental error? \n\nThe Hasse diagram with blocking looks like\n\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-15_b2d89b26e0ba557de084213338045ba0'}\n::: {.cell-output-display}\n![](experimentaldesign_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n\n\nThe model for this is\n\n$$\n\\begin{aligned}\nY_{ijkl} = \\alpha_i + b_{k} &+ (\\alpha b)_{l(ik)}\\\\\n&\\beta_j + \\alpha\\beta_{ij} +  \\varepsilon_{l(ijk)}\n\\end{aligned}\n$$\nwhere:\n\n- $\\alpha$ is whole plot factor (variety) ($i = 1 \\dots 3$)\n- $b_k$ is blocking ($k = 1 \\dots 6$)\n- $(\\alpha b)_{k(i)}$ is the whole plot error k replicates nested inside the whole plot factor\n- $\\beta_j$ - subplot factor (Nitrogen) ($j = 1 \\dots 4$)\n- $(\\alpha\\beta)_{ij}$ - interaction of whole plot factor and subplot factor\n- $\\varepsilon_{ijk}$ - split-plot level random error\n\n\n#### lm (wrong)\n\n\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-16_1ec1ba6cfbe9719afd4ab03229c19ded'}\n\n```{.r .cell-code}\n# Sum of Squres and MSE\noats_lm <- lm(yield~ block + variety*nitrogen + block:variety, data = oats)\nanova(oats_lm)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAnalysis of Variance Table\n\nResponse: yield\n                 Df  Sum Sq Mean Sq F value    Pr(>F)    \nblock             5 15875.3  3175.1 17.9297 9.525e-10 ***\nvariety           2  1786.4   893.2  5.0438  0.010557 *  \nnitrogen          3 20020.5  6673.5 37.6856 2.458e-12 ***\nvariety:nitrogen  6   321.8    53.6  0.3028  0.932199    \nblock:variety    10  6013.3   601.3  3.3957  0.002251 ** \nResiduals        45  7968.8   177.1                      \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n\nAgain, the analysis here ignores that there is a different replication for the whole plots, and so block and variety are tested with the wrong denominator. Nonetheless, it is still useful to have the mean squared errors. We drop the interaction\n\n\n#### aov \n\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-17_c3f0a66bb20a9d6d8afca398e0e3c545'}\n\n```{.r .cell-code}\n# Fixed block effect\n# oats_aov_block_fixed <- aov(yield~ block + variety*nitrogen + Error(block:variety), data = oats) # singular error, but correct\n# oats_aov_block_fixed <- aov(yield~ block + variety*nitrogen + Error(block:field123), data = oats) # singular error, but correct\noats_aov_block_fixed <- aov(yield~ block + variety*nitrogen + Error(field), data = oats) # need to number each whole plot separately\nsummary(oats_aov_block_fixed)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nError: field\n          Df Sum Sq Mean Sq F value Pr(>F)  \nblock      5  15875    3175   5.280 0.0124 *\nvariety    2   1786     893   1.485 0.2724  \nResiduals 10   6013     601                 \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nError: Within\n                 Df Sum Sq Mean Sq F value   Pr(>F)    \nnitrogen          3  20020    6673  37.686 2.46e-12 ***\nvariety:nitrogen  6    322      54   0.303    0.932    \nResiduals        45   7969     177                     \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-18_5bc12f9efbcc3a2bcf8d84fb0fcc1143'}\n\n```{.r .cell-code}\n# Random block effects\n# oats_aov_block_random <- aov(yield~ block + variety*nitrogen + Error(block)+ Error(block:variety), data = oats) # the below is technically short for this, but aov only allows 1 `Error` term, so you must specify like that.\n# oats_aov_block_random <- aov(yield~ block + variety*nitrogen + Error(block/field), data = oats)  # gives singular error, but correct.\n# oats_aov_block_random <- aov(yield~ block + variety*nitrogen + Error(block/field123), data = oats)  # aov prefers numbered 123 across the blocks\noats_aov_block_random <- aov(yield~ block + variety*nitrogen + Error(block/variety), data = oats)\nsummary(oats_aov_block_random)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nError: block\n      Df Sum Sq Mean Sq\nblock  5  15875    3175\n\nError: block:variety\n          Df Sum Sq Mean Sq F value Pr(>F)\nvariety    2   1786   893.2   1.485  0.272\nResiduals 10   6013   601.3               \n\nError: Within\n                 Df Sum Sq Mean Sq F value   Pr(>F)    \nnitrogen          3  20020    6673  37.686 2.46e-12 ***\nvariety:nitrogen  6    322      54   0.303    0.932    \nResiduals        45   7969     177                     \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n\nNote that we don't get a p-value for the random block now, since block gets its own error term. we also get the same results from when we treated block as fixed.\n\nSince there's no interaction between variety and nitrogen, we can drop that from the model and get this as the final model.\n\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-19_9978f12a7e033bf338f0069bf1ce4de1'}\n\n```{.r .cell-code}\n# No interaction\noats_aov_block_fixed_additive <- aov(yield~ block + nitrogen + variety + Error(block/variety), data = oats)\nsummary(oats_aov_block_fixed_additive)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nError: block\n      Df Sum Sq Mean Sq\nblock  5  15875    3175\n\nError: block:variety\n          Df Sum Sq Mean Sq F value Pr(>F)\nvariety    2   1786   893.2   1.485  0.272\nResiduals 10   6013   601.3               \n\nError: Within\n          Df Sum Sq Mean Sq F value   Pr(>F)    \nnitrogen   3  20020    6673   41.05 1.23e-13 ***\nResiduals 51   8290     163                     \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n\n#### lmer\n\n\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-20_b0be6767848369c30545d2fcad76cb10'}\n\n```{.r .cell-code}\n# Mixed model approach, fixed block \n# oats_lmer_block_fixed <- lmer(yield~ block + variety*nitrogen + (1 | block:variety), data = oats)\noats_lmer_block_fixed <- lmer(yield~ block + variety*nitrogen + (1 | field), data = oats)\nanova(oats_lmer_block_fixed)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nType III Analysis of Variance Table with Satterthwaite's method\n                  Sum Sq Mean Sq NumDF DenDF F value    Pr(>F)    \nblock             4675.0   935.0     5    10  5.2800   0.01244 *  \nvariety            526.1   263.0     2    10  1.4853   0.27239    \nnitrogen         20020.5  6673.5     3    45 37.6856 2.458e-12 ***\nvariety:nitrogen   321.8    53.6     6    45  0.3028   0.93220    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n\n```{.r .cell-code}\n# block random\n# oats_lmer_block_random <- lmer(yield~ variety*nitrogen + (1 | block) + (1|block:variety), data = oats)\n# oats_lmer_block_random <- lmer(yield~ variety*nitrogen + (1 | block/field123), data = oats) # shorthand\n# oats_lmer_block_random <- lmer(yield~ variety*nitrogen + (1 | block/field), data = oats) # as long as block:field reduces to a unique 18 terms\n# oats_lmer_block_random <- lmer(yield~ variety*nitrogen + (1 | block) + (1|field), data = oats) # as long as block:field reduces to a unique 18 terms, we can specify random error however.\noats_lmer_block_random <- lmer(yield~ variety*nitrogen + (1 | block/variety), data = oats) # shorthand\nanova(oats_lmer_block_random)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nType III Analysis of Variance Table with Satterthwaite's method\n                  Sum Sq Mean Sq NumDF DenDF F value    Pr(>F)    \nvariety            526.1   263.0     2    10  1.4853    0.2724    \nnitrogen         20020.5  6673.5     3    45 37.6857 2.458e-12 ***\nvariety:nitrogen   321.7    53.6     6    45  0.3028    0.9322    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n\n\nSince interaction is non significant, and treating block as random doesn't change the analysis, we drop interaction from model for the final model.\n\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-21_403a5ad36fca6e5b9ff18606c230fc90'}\n\n```{.r .cell-code}\n# dropping non-significant interaction term, fixed block\noats_lmer_block_fixed_additive <- lmer(yield~ block + variety + nitrogen + (1 | field), data = oats) # shorthand\n\n# dropping non-significant interaction term, random block\noats_lmer_block_random_additive <- lmer(yield~ variety + nitrogen + (1 | block/variety), data = oats) # shorthand\n```\n:::\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-22_84c64cc4ce014eaffbcb351813d8b767'}\n\n```{.r .cell-code}\nsummary(oats_lmer_block_fixed_additive)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nLinear mixed model fit by REML. t-tests use Satterthwaite's method [\nlmerModLmerTest]\nFormula: yield ~ block + variety + nitrogen + (1 | field)\n   Data: oats\n\nREML criterion at convergence: 525.6\n\nScaled residuals: \n     Min       1Q   Median       3Q      Max \n-1.96728 -0.65956 -0.02455  0.61656  1.69168 \n\nRandom effects:\n Groups   Name        Variance Std.Dev.\n field    (Intercept) 109.7    10.47   \n Residual             162.6    12.75   \nNumber of obs: 72, groups:  field, 18\n\nFixed effects:\n                  Estimate Std. Error       df t value Pr(>|t|)    \n(Intercept)       135.8611     8.1740  10.0000  16.621 1.30e-08 ***\nblockII           -28.0833    10.0111  10.0000  -2.805  0.01863 *  \nblockIII          -39.4167    10.0111  10.0000  -3.937  0.00279 ** \nblockIV           -37.1667    10.0111  10.0000  -3.713  0.00402 ** \nblockV            -44.4167    10.0111  10.0000  -4.437  0.00126 ** \nblockVI           -39.0833    10.0111  10.0000  -3.904  0.00294 ** \nvarietyMarvellous   5.2917     7.0789  10.0000   0.748  0.47196    \nvarietyVictory     -6.8750     7.0789  10.0000  -0.971  0.35436    \nnitrogen.L         32.9447     3.0052  51.0000  10.963 5.12e-15 ***\nnitrogen.Q         -5.1667     3.0052  51.0000  -1.719  0.09163 .  \nnitrogen.C         -0.4472     3.0052  51.0000  -0.149  0.88229    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nCorrelation of Fixed Effects:\n            (Intr) blckII blcIII blckIV blockV blckVI vrtyMr vrtyVc ntrg.L\nblockII     -0.612                                                        \nblockIII    -0.612  0.500                                                 \nblockIV     -0.612  0.500  0.500                                          \nblockV      -0.612  0.500  0.500  0.500                                   \nblockVI     -0.612  0.500  0.500  0.500  0.500                            \nvartyMrvlls -0.433  0.000  0.000  0.000  0.000  0.000                     \nvarityVctry -0.433  0.000  0.000  0.000  0.000  0.000  0.500              \nnitrogen.L   0.000  0.000  0.000  0.000  0.000  0.000  0.000  0.000       \nnitrogen.Q   0.000  0.000  0.000  0.000  0.000  0.000  0.000  0.000  0.000\nnitrogen.C   0.000  0.000  0.000  0.000  0.000  0.000  0.000  0.000  0.000\n            ntrg.Q\nblockII           \nblockIII          \nblockIV           \nblockV            \nblockVI           \nvartyMrvlls       \nvarityVctry       \nnitrogen.L        \nnitrogen.Q        \nnitrogen.C   0.000\n```\n:::\n:::\n\n\n\n#### emmeans (manual calculation)\n\nIf we want to average across the random whole plots, and have an estimate for the variability of nitrogen, we are now considering two sources of variability, the subplot error (residual) and whole plot error. Thus, this is loosely a linear combination of chi-square distributions, thus we need a df approximation.\n\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-23_89889386ade2c885998fa7dc131626f2'}\n\n```{.r .cell-code}\n# the manual calculation of the satterthwaite approximation\noats_lmer_block_fixed_additive_emm <- emmeans(oats_lmer_block_fixed_additive, specs = \"nitrogen\", lmer.df = \"satterthwaite\")\noats_lmer_block_fixed_additive_emm\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n nitrogen emmean   SE   df lower.CL upper.CL\n 0.0cwt     79.4 3.89 29.1     71.4     87.3\n 0.2cwt     98.9 3.89 29.1     90.9    106.8\n 0.4cwt    114.2 3.89 29.1    106.3    122.2\n 0.6cwt    123.4 3.89 29.1    115.4    131.3\n\nResults are averaged over the levels of: block, variety \nDegrees-of-freedom method: satterthwaite \nConfidence level used: 0.95 \n```\n:::\n:::\n\n\n\nWhen we treat block as random, we have even more uncertainty over the average levels because we're incorporating more variability from block.\n\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-24_4ce853ee4d6c887f6140700cc38f41bb'}\n\n```{.r .cell-code}\noats_lmer_block_random_additive_emm <- emmeans(oats_lmer_block_random_additive, specs = \"nitrogen\", lmer.df = \"satterthwaite\")\noats_lmer_block_random_additive_emm\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n nitrogen emmean   SE   df lower.CL upper.CL\n 0.0cwt     79.4 7.13 6.64     62.3     96.4\n 0.2cwt     98.9 7.13 6.64     81.8    115.9\n 0.4cwt    114.2 7.13 6.64     97.2    131.3\n 0.6cwt    123.4 7.13 6.64    106.3    140.4\n\nResults are averaged over the levels of: variety \nDegrees-of-freedom method: satterthwaite \nConfidence level used: 0.95 \n```\n:::\n:::\n\n\nIn the output, we note a partial degree of freedom. How do we use satterthwaite formula to get this df approximation? (and subsequently, the standard error used to calculate the confidence limits). Nitrogen is indexed by $j$, so we are ultimately interested in $\\overline{Y_{\\cdot j \\cdot}}$, this is the \"emmean\" estimate for average nitrogen, in which we average over variety and block.\n\n$$\n\\begin{aligned}\nSE(\\overline{Y_{\\cdot j \\cdot}}) &= \\sqrt{\\hat{\\operatorname{Var}}(\\overline{Y_{\\cdot j \\cdot}})} \\\\\n\\operatorname{Var}(\\overline{Y_{\\cdot j \\cdot}}) &= \\operatorname{Var}\\left(\\frac{\\sum_{i=1}^3\\sum_{k=1}^6Y_{ijk}}{(3)(6)}\\right) \\\\\n&= \\frac{1}{18} (\\sigma_W^2 + \\sigma^2)\n\\end{aligned}\n$$\n\nFrom the expected mean squares, a moment estimator of the variances are\n\n$$\n\\begin{aligned}\n\\hat\\sigma^2 &= SPMSE \\\\\n\\hat \\sigma^2_W &= \\frac{1}{4}(WPMSE - SPMSE)\n\\end{aligned}\n$$\n$$\n\\begin{aligned}\n\\hat{\\operatorname{Var}}(\\overline{Y_{\\cdot j \\cdot}}) &= \\frac{1}{72}WPMSE + \\frac{3}{72}SPMSE\n\\end{aligned}\n$$\n\nNow we also know that the mean squared errors have chi-squared distributions (because the are quadratic forms). This is where satterwaithe formula comes in. Now we just need to plug in the squared errors\n\n$$\n\\begin{aligned}\n\\nu \\approx \\frac{(\\sum k_is_i^2)^2}{\\sum_i\\frac{(k_is^2_i)^2}{\\nu_i}}\n\\end{aligned}\n$$\n\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-25_0069cc5442d17d670df1739b28d6ec9e'}\n\n```{.r .cell-code}\noats_lm_block_additive <- lm(yield~ block + variety + nitrogen + block:variety, data = oats)\nanova(oats_lm_block_additive)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAnalysis of Variance Table\n\nResponse: yield\n              Df  Sum Sq Mean Sq F value    Pr(>F)    \nblock          5 15875.3  3175.1 19.5317 8.101e-11 ***\nvariety        2  1786.4   893.2  5.4945 0.0069026 ** \nnitrogen       3 20020.5  6673.5 41.0528 1.228e-13 ***\nblock:variety 10  6013.3   601.3  3.6992 0.0009032 ***\nResiduals     51  8290.5   162.6                      \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-26_d9c83fbc6ef5c1b526551ebc126c02c9'}\n\n```{.r .cell-code}\n# with variance estimates\nsperr <- 162.6 # subplot error\nwperr <- (601.3 - 162.6) / 4 # whole plot variance estimate\navg_nitro_se <- sqrt(1/18*(wperr + sperr))\navg_nitro_se\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 3.889266\n```\n:::\n:::\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-27_a73c3d87b8438689eb91bef1776ec144'}\n\n```{.r .cell-code}\n# with mean squared values\nwpmse <- 601.3 # Whole plot Mean Square\nwpdf <- 10 # Whole plot degrees of freedom\nspmse <- 162.6 # sub plot mean squared\nspdf <- 51 # sub plot degrees of freedom\n\n# satterwaithe approximation\napprox_df <- (1/72*wpmse + 3/72*spmse)^2 / ((1/72*wpmse)^2 / wpdf + (3/72*spmse)^2 / spdf)\napprox_df\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 29.05648\n```\n:::\n:::\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-28_a9b89c2ae8fb4f181deab3d3391f8502'}\n\n```{.r .cell-code}\n# lower confidence limit\nnitro1_est <- oats %>% filter(nitrogen == \"0.0cwt\") %>% \n  pull(yield) %>% mean()\n\nnitro1_est + avg_nitro_se * qt(.025, approx_df) # Lower\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 71.43512\n```\n:::\n\n```{.r .cell-code}\nnitro1_est + avg_nitro_se * qt(.975, approx_df) # Upper\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 87.34266\n```\n:::\n:::\n\n\nWe can see now all the values match up with emmeans!\n\n#### emmeans plot (misleading)\n\nThis is a criticism from [Should blocks be random or fixed?](https://newprairiepress.org/cgi/viewcontent.cgi?referer=&httpsredir=1&article=1474&context=agstatconference) for when we treat blocks as random. He concludes by stating his preference for fixed blocks.\n\nThe following graphic is a useful summarization for showing levels of nitrogen change, and often would like to show error bars around those mean estimates. However, when we treat blocks as random (field), we are adding an additional source of variation to the standard error estimates of the mean. When we plot it, the error bars thus look huge, compared to the fixed effects case. Whereas the significance for the difference between the two groups are the same. Even though they overlap, the difference can still be significant.\n\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-29_63ed53ea687a9da189a5b208433ab06e'}\n\n```{.r .cell-code}\npairs(oats_lmer_block_random_additive_emm)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n contrast        estimate   SE df t.ratio p.value\n 0.0cwt - 0.2cwt   -19.50 4.25 51  -4.588  0.0002\n 0.0cwt - 0.4cwt   -34.83 4.25 51  -8.196  <.0001\n 0.0cwt - 0.6cwt   -44.00 4.25 51 -10.353  <.0001\n 0.2cwt - 0.4cwt   -15.33 4.25 51  -3.608  0.0038\n 0.2cwt - 0.6cwt   -24.50 4.25 51  -5.765  <.0001\n 0.4cwt - 0.6cwt    -9.17 4.25 51  -2.157  0.1493\n\nResults are averaged over the levels of: variety \nDegrees-of-freedom method: satterthwaite \nP value adjustment: tukey method for comparing a family of 4 estimates \n```\n:::\n:::\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-30_2afae3359c7c7f70bd94ec117a3700b1'}\n\n```{.r .cell-code}\nplot(oats_lmer_block_random_additive_emm)\n```\n\n::: {.cell-output-display}\n![](experimentaldesign_files/figure-html/unnamed-chunk-30-1.png){width=672}\n:::\n:::\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-31_8182db6fd61786944fca2de32ed46eed'}\n\n```{.r .cell-code}\npairs(oats_lmer_block_fixed_additive_emm)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n contrast        estimate   SE df t.ratio p.value\n 0.0cwt - 0.2cwt   -19.50 4.25 51  -4.588  0.0002\n 0.0cwt - 0.4cwt   -34.83 4.25 51  -8.196  <.0001\n 0.0cwt - 0.6cwt   -44.00 4.25 51 -10.353  <.0001\n 0.2cwt - 0.4cwt   -15.33 4.25 51  -3.608  0.0038\n 0.2cwt - 0.6cwt   -24.50 4.25 51  -5.765  <.0001\n 0.4cwt - 0.6cwt    -9.17 4.25 51  -2.157  0.1493\n\nResults are averaged over the levels of: block, variety \nDegrees-of-freedom method: satterthwaite \nP value adjustment: tukey method for comparing a family of 4 estimates \n```\n:::\n:::\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-32_529143fb664666881e66357cd48b0b78'}\n\n```{.r .cell-code}\nplot(oats_lmer_block_fixed_additive_emm)\n```\n\n::: {.cell-output-display}\n![](experimentaldesign_files/figure-html/unnamed-chunk-32-1.png){width=672}\n:::\n:::\n\n\n\n## Steel Example {.tabset}\n\nBased on (Box et. al 2005) Experiment designed to study the corrosion resistance of steel bars treated with 4 coatings, $C_1, C_2, C_3, C_4$ at three furnace temperatures $360^{\\circ}C, 370^{\\circ}C,380^{\\circ}C$. Furnace temperature is considered a hard to change factor because of the time it takes to reset the furnace and reach equilibriu temperature. Once the equilibrium temperature is reached, 4 steel bars with randomly assigned coating are randomly positioned in the furnace and heated. The first three temperatures were run on day 1, and the second three temperatures were run on day 2.\n\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-33_7245116e58016d68be041ac3a6896d56'}\n\n:::\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-34_d5ffbcf394b5c4aa3b43dd27e12620cc'}\n::: {.cell-output .cell-output-stdout}\n```\n     y coating temp day\n1   73       2  360   1\n2   83       3  360   1\n3   67       1  360   1\n4   89       4  360   1\n5   65       1  370   1\n6   87       3  370   1\n7   86       4  370   1\n8   91       2  370   1\n9  147       3  380   1\n10 155       1  380   1\n11 127       2  380   1\n12 212       4  380   1\n13 153       4  380   2\n14  90       3  380   2\n15 100       2  380   2\n16 108       1  380   2\n17 150       4  370   2\n18 140       1  370   2\n19 121       3  370   2\n20 142       2  370   2\n21  33       1  360   2\n22  54       4  360   2\n23   8       2  360   2\n24  46       3  360   2\n```\n:::\n:::\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-35_fdccd7a9f6ea23dacfab2f6f9595b66b'}\n::: {.cell-output-display}\n![](experimentaldesign_files/figure-html/unnamed-chunk-35-1.png){width=672}\n:::\n:::\n\n\nIf we pretend that the randomization was not done with day as a blocking factor, then we have a split plot with CRD in whole plots and CRD in subplots.\n\n### with day block\n\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-36_42c462d453f11d4881c3af319bb3fed2'}\n\n```{.r .cell-code}\n# just get df table, and mean squares\n# wrong denominator for temp effect\nsteel_lm_block <- lm(y ~ day + coating*temp + day:temp, data = steel)\nanova(steel_lm_block)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAnalysis of Variance Table\n\nResponse: y\n             Df  Sum Sq Mean Sq  F value    Pr(>F)    \nday           1   782.0   782.0   6.2794  0.033538 *  \ncoating       3  4289.1  1429.7  11.4798  0.001977 ** \ntemp          2 26519.2 13259.6 106.4674 5.446e-07 ***\ncoating:temp  6  3269.7   545.0   4.3757  0.024066 *  \nday:temp      2 13657.6  6828.8  54.8314 9.113e-06 ***\nResiduals     9  1120.9   124.5                       \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n\n```{.r .cell-code}\n# correct split plot analysis\nsteel_aov_block <- aov(y ~ day + coating*temp + Error(day:temp), data = steel)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in aov(y ~ day + coating * temp + Error(day:temp), data = steel):\nError() model is singular\n```\n:::\n\n```{.r .cell-code}\nsummary(steel_aov_block)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nError: day:temp\n          Df Sum Sq Mean Sq F value Pr(>F)\nday        1    782     782   0.115  0.767\ntemp       2  26519   13260   1.942  0.340\nResiduals  2  13658    6829               \n\nError: Within\n             Df Sum Sq Mean Sq F value  Pr(>F)   \ncoating       3   4289  1429.7  11.480 0.00198 **\ncoating:temp  6   3270   545.0   4.376 0.02407 * \nResiduals     9   1121   124.5                   \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n\n```{.r .cell-code}\n# correct split plot analysis\nsteel_lmer_block <- lmer(y~ day + coating*temp + (1|temp:day), data = steel)\nanova(steel_lmer_block)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nType III Analysis of Variance Table with Satterthwaite's method\n             Sum Sq Mean Sq NumDF DenDF F value   Pr(>F)   \nday            14.3   14.26     1     2  0.1145 0.767278   \ncoating      4289.1 1429.71     3     9 11.4798 0.001977 **\ntemp          483.7  241.83     2     2  1.9417 0.339937   \ncoating:temp 3269.7  544.96     6     9  4.3757 0.024066 * \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n\n### without day block\n\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-37_e97c5cfb4d23948f296973fe2a8714f9'}\n\n```{.r .cell-code}\n# without blocking\nsteel_lmer <- lmer(y~coating*temp + (1|temp:day), data = steel)\nanova(steel_lmer)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nType III Analysis of Variance Table with Satterthwaite's method\n             Sum Sq Mean Sq NumDF DenDF F value   Pr(>F)   \ncoating      4289.1 1429.71     3     9 11.4798 0.001977 **\ntemp          686.2  343.09     2     3  2.7548 0.209321   \ncoating:temp 3269.7  544.96     6     9  4.3757 0.024066 * \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-38_78fb0b385d4c1e004936faddd0e36b89'}\n::: {.cell-output-display}\n![](experimentaldesign_files/figure-html/unnamed-chunk-38-1.png){width=672}\n:::\n:::\n\n\n\n### with block:treatment\n\nWe just check the model seperating the block x sp-treatment out from the residual term.\n\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-39_e495d72137d6cd3a29bfb85fd76be312'}\n\n```{.r .cell-code}\nsteel_lmer_block_interact <- lmer(y ~ day + coating*temp + day:coating + (1|temp:day), data = steel)\nanova(steel_lmer_block_interact)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nType III Analysis of Variance Table with Satterthwaite's method\n             Sum Sq Mean Sq NumDF  DenDF F value   Pr(>F)   \nday            16.5   16.54     1 2.0001  0.1145 0.767273   \ncoating      4289.1 1429.71     3 6.0000  9.8969 0.009714 **\ntemp          561.0  280.51     2 2.0001  1.9418 0.339922   \ncoating:temp 3269.8  544.96     6 6.0000  3.7724 0.065509 . \nday:coating   254.1   84.71     3 6.0000  0.5864 0.645799   \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n\n\n### fake data\n\nHere I try to simulate data\n\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-40_01c12aff3b9f384d4014dac12bbd3b63'}\n\n```{.r .cell-code}\nfake_y <- function(day, coating, temp){\n  temp <- scale(as.numeric(temp), scale = F)\n  day <- as.numeric(day)\n  coating <- as.numeric(coating)\n  n <- length(day)\n  2 * day + 2 * temp + (day*temp)*rnorm(n, mean = 2) + .2*coating + 20*day*coating + rnorm(n)\n}\n\nfake_steel <- steel %>% add_column(fake_y = fake_y(steel$day, steel$coating, steel$temp)) \n```\n:::\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-41_74f5f1009cbb9f31f927de467f479a88'}\n::: {.cell-output-display}\n![](experimentaldesign_files/figure-html/unnamed-chunk-41-1.png){width=672}\n:::\n:::\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-42_d08ca5f8902eef1438701be551c96b44'}\n\n```{.r .cell-code}\nfake_steel_aov <- aov(fake_y ~ (day + coating + temp)^2 - day:temp + Error(day:temp), data = fake_steel)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in aov(fake_y ~ (day + coating + temp)^2 - day:temp + Error(day:temp), :\nError() model is singular\n```\n:::\n\n```{.r .cell-code}\nfake_steel_aov\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\naov(formula = fake_y ~ (day + coating + temp)^2 - day:temp + \n    Error(day:temp), data = fake_steel)\n\nGrand Mean: 86.29519\n\nStratum 1: day:temp\n\nTerms:\n                     day     temp Residuals\nSum of Squares  21602.92 41460.73   1605.22\nDeg. of Freedom        1        2         2\n\nResidual standard error: 28.33036\n9 out of 12 effects not estimable\nEstimated effects may be unbalanced\n\nStratum 2: Within\n\nTerms:\n                  coating day:coating coating:temp Residuals\nSum of Squares  25013.316    2433.340     1007.761  1326.953\nDeg. of Freedom         3           3            6         6\n\nResidual standard error: 14.87141\nEstimated effects may be unbalanced\n```\n:::\n\n```{.r .cell-code}\nsummary(fake_steel_aov)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nError: day:temp\n          Df Sum Sq Mean Sq F value Pr(>F)  \nday        1  21603   21603   26.92 0.0352 *\ntemp       2  41461   20730   25.83 0.0373 *\nResiduals  2   1605     803                 \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nError: Within\n             Df Sum Sq Mean Sq F value   Pr(>F)    \ncoating       3  25013    8338  37.700 0.000274 ***\nday:coating   3   2433     811   3.668 0.082345 .  \ncoating:temp  6   1008     168   0.759 0.626583    \nResiduals     6   1327     221                     \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n\n# Nested Variable labeling\n\nWhen working with a client, it seems that the labeling of nested variables is quite the headache, so this section is to work out the differences in the estimation in linear models. and where the differences in ANOVA appear.\n\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-43_1e769393d6070815f7dd3bcad8a62137'}\n\n```{.r .cell-code}\n# Simulate the data for a nested block environment\nset.seed(1)\nsimulate_data <- function(environ, block, treat) {\n  environ_effect <- c(2, 3)\n  block_effect <- runif(6)\n  treat_effect <- runif(2)\n  y <- environ_effect[as.numeric(environ)] + \n    block_effect[as.numeric(block)] + \n    treat_effect[as.numeric(treat)] +\n    rnorm(length(environ))\n  y\n}\n\ndat <- tibble(environ = gl(2, 6),\n              block123 = factor(rep(1:3, 4)),\n              block = factor(c(rep(1:3, times = 2), \n                               rep(4:6, times = 2))),\n              treat = factor(rep(letters[1:2], each = 3, times = 2))) %>% \n  mutate(y = simulate_data(environ, block, treat))\n\ndat %>% head(n=10)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 10  5\n   environ block123 block treat     y\n   <fct>   <fct>    <fct> <fct> <dbl>\n 1 1       1        1     a      3.54\n 2 1       2        2     a      2.50\n 3 1       3        3     a      4.00\n 4 1       1        1     b      3.66\n 5 1       2        2     b      3.61\n 6 1       3        3     b      2.93\n 7 2       1        4     a      6.36\n 8 2       2        5     a      4.54\n 9 2       3        6     a      4.22\n10 2       1        4     b      2.35\n```\n:::\n:::\n\n\nThe numbering in this dataset is such that the block numbering goes across the environments. consider the following two models and their anova tables\n\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-44_03ab71b95818cbd79d0e80c4822585cd'}\n\n```{.r .cell-code}\n# Note the sum squares are all the same!\nmod <- lm(y~environ + environ:block123 + treat + treat:environ, data = dat)\nmod2 <- lm(y ~ environ + block + treat + treat:environ, data = dat)\n```\n:::\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-45_a7cb39e799f9f804756474df5c5c7682'}\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"width: auto !important; float: left; margin-right: 10px;\">\n<caption>Numbered within Environments</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\">   </th>\n   <th style=\"text-align:right;\"> Df </th>\n   <th style=\"text-align:right;\"> Sum Sq </th>\n   <th style=\"text-align:right;\"> Mean Sq </th>\n   <th style=\"text-align:right;\"> F value </th>\n   <th style=\"text-align:right;\"> Pr(&gt;F) </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> environ </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 3.7812335 </td>\n   <td style=\"text-align:right;\"> 3.7812335 </td>\n   <td style=\"text-align:right;\"> 1.9876925 </td>\n   <td style=\"text-align:right;\"> 0.2313888 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> treat </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0.8039892 </td>\n   <td style=\"text-align:right;\"> 0.8039892 </td>\n   <td style=\"text-align:right;\"> 0.4226354 </td>\n   <td style=\"text-align:right;\"> 0.5510743 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> environ:block123 </td>\n   <td style=\"text-align:right;\"> 4 </td>\n   <td style=\"text-align:right;\"> 0.5392957 </td>\n   <td style=\"text-align:right;\"> 0.1348239 </td>\n   <td style=\"text-align:right;\"> 0.0708733 </td>\n   <td style=\"text-align:right;\"> 0.9874393 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> environ:treat </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0.9788858 </td>\n   <td style=\"text-align:right;\"> 0.9788858 </td>\n   <td style=\"text-align:right;\"> 0.5145739 </td>\n   <td style=\"text-align:right;\"> 0.5128253 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Residuals </td>\n   <td style=\"text-align:right;\"> 4 </td>\n   <td style=\"text-align:right;\"> 7.6092926 </td>\n   <td style=\"text-align:right;\"> 1.9023231 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"width: auto !important; \">\n<caption>Numbered across Environments</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\">   </th>\n   <th style=\"text-align:right;\"> Df </th>\n   <th style=\"text-align:right;\"> Sum Sq </th>\n   <th style=\"text-align:right;\"> Mean Sq </th>\n   <th style=\"text-align:right;\"> F value </th>\n   <th style=\"text-align:right;\"> Pr(&gt;F) </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> environ </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 3.7812335 </td>\n   <td style=\"text-align:right;\"> 3.7812335 </td>\n   <td style=\"text-align:right;\"> 1.9876925 </td>\n   <td style=\"text-align:right;\"> 0.2313888 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> block </td>\n   <td style=\"text-align:right;\"> 4 </td>\n   <td style=\"text-align:right;\"> 0.5392957 </td>\n   <td style=\"text-align:right;\"> 0.1348239 </td>\n   <td style=\"text-align:right;\"> 0.0708733 </td>\n   <td style=\"text-align:right;\"> 0.9874393 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> treat </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0.8039892 </td>\n   <td style=\"text-align:right;\"> 0.8039892 </td>\n   <td style=\"text-align:right;\"> 0.4226354 </td>\n   <td style=\"text-align:right;\"> 0.5510743 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> environ:treat </td>\n   <td style=\"text-align:right;\"> 1 </td>\n   <td style=\"text-align:right;\"> 0.9788858 </td>\n   <td style=\"text-align:right;\"> 0.9788858 </td>\n   <td style=\"text-align:right;\"> 0.5145739 </td>\n   <td style=\"text-align:right;\"> 0.5128253 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Residuals </td>\n   <td style=\"text-align:right;\"> 4 </td>\n   <td style=\"text-align:right;\"> 7.6092926 </td>\n   <td style=\"text-align:right;\"> 1.9023231 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nSubstituting `environ:block123` with `block` when the numbering is the same gives the same ANOVA table.\n\nThe difference between these two models is that the nesting is more explicitly stated when the blocks are labeled within each environment and that there is no \"aliasing\" of effects either. It might not be clear from the second model that even though \"block\" has 6 levels, why the df = 4 in the anova table when it should intuitively be 5. It's because there is aliasing with the environment variable, so environment takes 1 df away, and thus one of the estimates of the block is singular. This can be seen in the output of `summary(mod)`:\n\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-46_96c4cf1845a76f98c9131484673f9487'}\n\n```{.r .cell-code}\nsummary(mod2) # 1 coefficient is aliased\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nlm(formula = y ~ environ + block + treat + treat:environ, data = dat)\n\nResiduals:\n      1       2       3       4       5       6       7       8       9      10 \n-0.0357 -0.5294  0.5651  0.0357  0.5294 -0.5651  1.4607 -0.7701 -0.6907 -1.4607 \n     11      12 \n 0.7701  0.6907 \n\nCoefficients: (1 not defined because of singularities)\n                 Estimate Std. Error t value Pr(>|t|)  \n(Intercept)      3.575392   1.126151   3.175   0.0337 *\nenviron2         1.337100   1.592618   0.840   0.4484  \nblock2          -0.549645   1.379247  -0.399   0.7106  \nblock3          -0.135551   1.379247  -0.098   0.9264  \nblock4          -0.008554   1.379247  -0.006   0.9953  \nblock5           0.393766   1.379247   0.285   0.7894  \nblock6                 NA         NA      NA       NA  \ntreatb           0.053539   1.126151   0.048   0.9644  \nenviron2:treatb -1.142445   1.592618  -0.717   0.5128  \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 1.379 on 4 degrees of freedom\nMultiple R-squared:  0.4451,\tAdjusted R-squared:  -0.526 \nF-statistic: 0.4583 on 7 and 4 DF,  p-value: 0.8269\n```\n:::\n:::\n\n\nShort aside - R knows the difference between nested and crossed data based on whether the main effect is included or not. Notice the difference between these examples, even though `environ:block123` is included in both models, it doesn't have the same degrees of freedom.\n\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-47_319c48e31881928f26fc208890e3a640'}\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"width: auto !important; float: left; margin-right: 10px;\">\n<caption>Nested Factor ANOVA</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> source </th>\n   <th style=\"text-align:left;\"> df </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Environ </td>\n   <td style=\"text-align:left;\"> a - 1 = 1 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Environ:block123 </td>\n   <td style=\"text-align:left;\"> a(b -1) = 4 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"width: auto !important; \">\n<caption>Crossed Factor ANOVA</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> source </th>\n   <th style=\"text-align:left;\"> df </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Environ </td>\n   <td style=\"text-align:left;\"> a - 1 = 1 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> block123 </td>\n   <td style=\"text-align:left;\"> b - 1 = 2 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Environ:block123 </td>\n   <td style=\"text-align:left;\"> (a-1)(b -1) = 2 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n::: {.cell hash='experimentaldesign_cache/html/unnamed-chunk-48_521bd428821f246c327f52b941c697b0'}\n\n```{.r .cell-code}\n# nest vs crossing df\nmod_nest <- lm(y ~ environ + environ:block123, data = dat)\nmod_cross <- lm(y ~ environ + block123 + environ:block123, data = dat)\n\nanova(mod_nest)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAnalysis of Variance Table\n\nResponse: y\n                 Df Sum Sq Mean Sq F value Pr(>F)\nenviron           1 3.7812  3.7812  2.4156 0.1711\nenviron:block123  4 0.5393  0.1348  0.0861 0.9836\nResiduals         6 9.3922  1.5654               \n```\n:::\n\n```{.r .cell-code}\nanova(mod_cross)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAnalysis of Variance Table\n\nResponse: y\n                 Df Sum Sq Mean Sq F value Pr(>F)\nenviron           1 3.7812  3.7812  2.4156 0.1711\nblock123          2 0.0127  0.0064  0.0041 0.9959\nenviron:block123  2 0.5265  0.2633  0.1682 0.8490\nResiduals         6 9.3922  1.5654               \n```\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}